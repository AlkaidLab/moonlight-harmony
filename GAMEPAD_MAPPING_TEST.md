# 手柄按钮映射测试指南

## 当前设备信息
- **VID**: 0x413D
- **PID**: 0x2103
- **名称**: Generic USB Gamepad

## 当前已知数据格式 (10 bytes)

| 字节 | 空闲值 | 功能 | 备注 |
|------|--------|------|------|
| [0]  | 0x01   | Report ID | 固定 |
| [1]  | 0x80   | 左摇杆 X | 0x00-0xFF, 0x80=中间 |
| [2]  | 0x80   | 左摇杆 Y | 0x00-0xFF, 0x80=中间 |
| [3]  | 0x80   | 右摇杆 X | 0x00-0xFF, 0x80=中间 |
| [4]  | 0x80   | 右摇杆 Y | 0x00-0xFF, 0x80=中间 |
| [5]  | 0x0F   | 扳机? | 需要测试 LT/RT |
| [6]  | 0x00   | D-Pad HAT | 0=中立, 1-8=方向 |
| [7]  | 0x00   | 功能按钮 | 0x02=面板按键激活? |
| [8]  | 0x00   | 面板按钮 | 位掩码: bit0=A, bit1=B... |
| [9]  | 0x00   | 保留 | 未知 |

## 已确认映射

### 面板按钮 (byte[8]) - 位掩码模式
测试数据:
- `01` = A 按下
- `02` = B 按下
- `03` = A+B 同时按下 (1+2=3，确认是位掩码)

推断映射:
- bit0 (0x01) = A ✓
- bit1 (0x02) = B ✓
- bit2 (0x04) = X (待测试)
- bit3 (0x08) = Y (待测试)
- bit4 (0x10) = LB (待测试)
- bit5 (0x20) = RB (待测试)

### D-Pad/HAT (byte[6])
标准 HAT 编码:
- 0x00 = 中立 ✓
- 0x01 = 上
- 0x02 = 上右
- 0x03 = 右
- 0x04 = 下右
- 0x05 = 下
- 0x06 = 下左
- 0x07 = 左
- 0x08 = 上左

## 需要测试的按钮

### 1. 扳机 (byte[5])
空闲值 = 0x0F

请按下 LT，记录 byte[5] 的值:
- LT 按下时: `____`

请按下 RT，记录 byte[5] 的值:
- RT 按下时: `____`

请同时按下 LT+RT，记录 byte[5] 的值:
- LT+RT 按下时: `____`

### 2. 功能按钮 (byte[7])

请按下 Start，记录 byte[7] 的值:
- Start: `____`

请按下 Back/Select，记录 byte[7] 的值:
- Back/Select: `____`

请按下 Home/Xbox/PS 按钮，记录 byte[7] 的值:
- Home: `____`

请按下左摇杆按钮 (LS)，记录 byte[7] 的值:
- LS_CLK: `____`

请按下右摇杆按钮 (RS)，记录 byte[7] 的值:
- RS_CLK: `____`

### 3. 面板按钮验证 (byte[8])

请按下 X，记录 byte[8] 的值:
- X: `____` (期望 0x04)

请按下 Y，记录 byte[8] 的值:
- Y: `____` (期望 0x08)

请按下 LB，记录 byte[8] 的值:
- LB: `____` (期望 0x10)

请按下 RB，记录 byte[8] 的值:
- RB: `____` (期望 0x20)

### 4. D-Pad 验证 (byte[6])

请按下 D-Pad 上，记录 byte[6] 的值:
- 上: `____` (期望 0x01)

请按下 D-Pad 下，记录 byte[6] 的值:
- 下: `____` (期望 0x05)

请按下 D-Pad 左，记录 byte[6] 的值:
- 左: `____` (期望 0x07)

请按下 D-Pad 右，记录 byte[6] 的值:
- 右: `____` (期望 0x03)

## 测试方法

1. 构建并安装更新后的应用
2. 连接手柄，进入游戏串流
3. 查看 HiLog 中的调试日志:
   ```
   hilog -T GamepadNAPI
   ```
4. 按下每个按钮，记录日志输出
5. 根据结果填写上方表格

## 日志格式

更新后的日志会显示:
```
Generic HID: sticks(0,0,0,0) hat=0 b5=0x0f b7=0x00 b8=0x01 -> buttons=0x1000
```

- `sticks` = 摇杆值
- `hat` = D-Pad 值
- `b5` = byte[5] 原始值
- `b7` = byte[7] 原始值
- `b8` = byte[8] 原始值
- `buttons` = 解析后的按钮标志

## 更新映射

测试完成后，需要根据结果修改 `gamepad_napi.cpp` 中的 `parseGenericHidReport` 函数。
