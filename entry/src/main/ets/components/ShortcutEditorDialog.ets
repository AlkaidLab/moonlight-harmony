/*
 * Moonlight for HarmonyOS
 * Copyright (C) 2024-2025 Moonlight/AlkaidLab
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 */

/**
 * å¿«æ·é”®ç¼–è¾‘å¯¹è¯æ¡†
 * 
 * ç”¨äºŽæ·»åŠ æˆ–ç¼–è¾‘è‡ªå®šä¹‰å¿«æ·é”®
 */
import { ShortcutManager, Shortcut, KeyOption } from './ShortcutManager';

/**
 * å¿«æ·é”®ç¼–è¾‘æ•°æ®ï¼ˆä¸åŒ…å« id å’Œ isBuiltinï¼‰
 */
export interface ShortcutEditData {
  name: string;
  keys: number[];
  icon?: string;
  color?: string;
}

export interface ShortcutEditorCallbacks {
  onSave: (data: ShortcutEditData) => void;
  onCancel: () => void;
}

@CustomDialog
export struct ShortcutEditorDialog {
  controller: CustomDialogController;
  editingShortcut?: Shortcut;  // å¦‚æžœä¼ å…¥åˆ™ä¸ºç¼–è¾‘æ¨¡å¼
  callbacks: ShortcutEditorCallbacks = {
    onSave: () => {},
    onCancel: () => {}
  };
  
  // ç¼–è¾‘çŠ¶æ€
  @State private name: string = '';
  @State private selectedKeys: number[] = [];
  @State private selectedIcon: string = 'âŒ¨ï¸';
  @State private selectedColor: string = '#9DABB2';  // èŽ«å…°è¿ªè“ç°
  
  // UI çŠ¶æ€
  @State private showKeyPicker: boolean = false;
  
  private shortcutManager = ShortcutManager.getInstance();
  private availableKeys: KeyOption[] = [];
  
  // å¯é€‰å›¾æ ‡
  private iconOptions: string[] = ['âŒ¨ï¸', 'ðŸŽ®', 'ðŸ–¥ï¸', 'ðŸ“', 'ðŸ”§', 'âš¡', 'ðŸŽ¯', 'ðŸ’¡', 'ðŸ”’', 'ðŸ”“'];
  
  // å¯é€‰é¢œè‰² - èŽ«å…°è¿ªè‰²ç³»ï¼ˆä½Žé¥±å’Œåº¦ã€æ¸©å’ŒæŸ”å’Œï¼‰
  private colorOptions: string[] = [
    '#9DABB2', '#A7B5AA', '#C5B4A0', '#B8A9C0', 
    '#C9A9A6', '#D4C5A9', '#8FA3AD', '#A8B4A5'
  ];
  
  // ä¿å­˜ç¼–è¾‘æ•°æ®çš„ä¸´æ—¶å¯¹è±¡
  private editData: ShortcutEditData = {
    name: '',
    keys: [],
    icon: undefined,
    color: undefined
  };
  
  /**
   * ä¿å­˜å¿«æ·é”®
   */
  private saveShortcut(): void {
    this.editData.name = this.name;
    this.editData.keys = this.selectedKeys;
    this.editData.icon = this.selectedIcon;
    this.editData.color = this.selectedColor;
    this.callbacks.onSave(this.editData);
    this.controller.close();
  }
  
  aboutToAppear(): void {
    this.availableKeys = this.shortcutManager.getAvailableKeys();
    
    // å¦‚æžœæ˜¯ç¼–è¾‘æ¨¡å¼ï¼ŒåŠ è½½çŽ°æœ‰æ•°æ®
    if (this.editingShortcut) {
      this.name = this.editingShortcut.name;
      this.selectedKeys = [...this.editingShortcut.keys];
      this.selectedIcon = this.editingShortcut.icon || 'âŒ¨ï¸';
      this.selectedColor = this.editingShortcut.color || '#9DABB2';  // èŽ«å…°è¿ªè“ç°
    }
  }
  
  build() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text(this.editingShortcut ? 'ç¼–è¾‘å¿«æ·é”®' : 'æ·»åŠ å¿«æ·é”®')
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#FFFFFF')
        Blank()
        Text('âœ•')
          .fontSize(16)
          .fontColor('#888888')
          .onClick(() => {
            this.controller.close();
            this.callbacks.onCancel();
          })
      }
      .width('100%')
      .margin({ bottom: 12 })
      
      // åç§°å’Œå›¾æ ‡é¢œè‰²åœ¨ä¸€è¡Œ
      Row() {
        // åç§°è¾“å…¥
        Column() {
          Text('åç§°')
            .fontSize(11)
            .fontColor('#666')
            .margin({ bottom: 4 })
          TextInput({ placeholder: 'å¿«æ·é”®åç§°', text: this.name })
            .fontSize(13)
            .fontColor('#FFF')
            .placeholderColor('#555')
            .backgroundColor('#333')
            .borderRadius(6)
            .height(32)
            .onChange((value) => { this.name = value; })
        }
        .layoutWeight(1)
        
        // å›¾æ ‡é€‰æ‹©
        Column() {
          Text('å›¾æ ‡')
            .fontSize(11)
            .fontColor('#666')
            .margin({ bottom: 4 })
          Row() {
            ForEach(this.iconOptions.slice(0, 5), (icon: string) => {
              Text(icon)
                .fontSize(16)
                .width(28)
                .height(28)
                .textAlign(TextAlign.Center)
                .backgroundColor(this.selectedIcon === icon ? `#50${this.selectedColor.replace('#', '')}` : 'transparent')
                .borderRadius(6)
                .onClick(() => { this.selectedIcon = icon; })
            })
          }
        }
        .margin({ left: 12 })
      }
      .width('100%')
      .margin({ bottom: 10 })
      
      // é¢œè‰²é€‰æ‹©
      Row() {
        Text('é¢œè‰²')
          .fontSize(11)
          .fontColor('#666')
        Blank()
        ForEach(this.colorOptions, (color: string, index: number) => {
          Column()
            .width(22)
            .height(22)
            .backgroundColor(color)
            .borderRadius(11)
            .border({ 
              width: this.selectedColor.toUpperCase() === color.toUpperCase() ? 2 : 0, 
              color: '#FFF' 
            })
            .margin({ left: 6 })
            .onClick(() => { this.selectedColor = color; })
        }, (color: string) => color)  // ä½¿ç”¨é¢œè‰²å€¼ä½œä¸ºå”¯ä¸€ key
      }
      .width('100%')
      .margin({ bottom: 10 })
      
      // æŒ‰é”®ç»„åˆ
      Column() {
        Row() {
          Text('æŒ‰é”®ç»„åˆ')
            .fontSize(11)
            .fontColor('#666')
          Blank()
          if (this.selectedKeys.length > 0) {
            Text('æ¸…ç©º')
              .fontSize(10)
              .fontColor('#FF6B6B')
              .onClick(() => { this.selectedKeys = []; })
          }
        }
        .width('100%')
        .margin({ bottom: 4 })
        
        // å·²é€‰æŒ‰é”®æ˜¾ç¤º
        Row() {
          if (this.selectedKeys.length === 0) {
            Text('ç‚¹å‡»ä¸‹æ–¹é€‰æ‹©æŒ‰é”®')
              .fontSize(12)
              .fontColor('#555')
          } else {
            ForEach(this.selectedKeys, (keyCode: number, index) => {
              Row() {
                Text(this.getKeyName(keyCode))
                  .fontSize(11)
                  .fontColor('#FFF')
                Text('Ã—')
                  .fontSize(9)
                  .fontColor('#888')
                  .margin({ left: 3 })
                  .onClick(() => {
                    this.selectedKeys = this.selectedKeys.filter((_, i) => i !== index);
                  })
              }
              .padding({ left: 6, right: 4, top: 3, bottom: 3 })
              .backgroundColor('#444')
              .borderRadius(4)
              .margin({ right: 4 })
            })
          }
        }
        .width('100%')
        .height(32)
        .padding({ left: 8, right: 8 })
        .backgroundColor('#333')
        .borderRadius(6)
        .alignItems(VerticalAlign.Center)
        
        // æŒ‰é”®é€‰æ‹©å™¨
        Scroll() {
          this.KeyPicker()
        }
        .width('100%')
        .constraintSize({ maxHeight: 200 })
        .scrollBar(BarState.Auto)
        .margin({ top: 6 })
      }
      .width('100%')
      .margin({ bottom: 10 })
      
      // é¢„è§ˆ
      Row() {
        Text(this.selectedIcon)
          .fontSize(16)
          .margin({ right: 8 })
        Column() {
          Text(this.name || 'åç§°')
            .fontSize(13)
            .fontColor('#FFF')
          Text(this.selectedKeys.length > 0 ? this.shortcutManager.keysToDisplayText(this.selectedKeys) : '--')
            .fontSize(10)
            .fontColor('#888')
        }
        .alignItems(HorizontalAlign.Start)
        Blank()
        Text('é¢„è§ˆ')
          .fontSize(10)
          .fontColor('#666')
      }
      .width('100%')
      .height(44)
      .padding({ left: 10, right: 10 })
      .backgroundColor(`#50${this.selectedColor.replace('#', '')}`)
      .borderRadius(8)
      .border({ width: 1, color: `#80${this.selectedColor.replace('#', '')}` })
      .margin({ bottom: 12 })
      
      // æ“ä½œæŒ‰é’®
      Row() {
        Button('å–æ¶ˆ')
          .fontSize(13)
          .fontColor('#AAA')
          .backgroundColor('#333')
          .borderRadius(8)
          .height(36)
          .layoutWeight(1)
          .onClick(() => {
            this.controller.close();
            this.callbacks.onCancel();
          })
        
        Button('ä¿å­˜')
          .fontSize(13)
          .fontColor('#FFF')
          .backgroundColor(this.canSave() ? this.selectedColor : '#444')
          .borderRadius(8)
          .height(36)
          .layoutWeight(1)
          .margin({ left: 10 })
          .enabled(this.canSave())
          .onClick(() => { this.saveShortcut(); })
      }
      .width('100%')
    }
    .width(320)
    .padding(16)
    .backgroundColor('#1A1A1A')
    .borderRadius(14)
  }
  
  @Builder
  KeyPicker() {
    Column() {
      // ä¿®é¥°é”®
      this.KeySection('ä¿®é¥°é”®', 'modifier')
      // åŠŸèƒ½é”®
      this.KeySection('åŠŸèƒ½é”®', 'function')
      // æ–¹å‘é”®
      this.KeySection('æ–¹å‘é”®', 'arrow')
      // Fé”®
      this.KeySection('F1-F12', 'fkey')
      // å­—æ¯
      this.KeySection('å­—æ¯', 'letter')
      // æ•°å­—
      this.KeySection('æ•°å­—', 'number')
      // ç¬¦å·
      this.KeySection('ç¬¦å·', 'symbol')
      // å°é”®ç›˜
      this.KeySection('å°é”®ç›˜', 'numpad')
      // åª’ä½“é”®
      this.KeySection('åª’ä½“', 'media')
    }
    .width('100%')
    .padding(8)
    .backgroundColor('#222')
    .borderRadius(8)
  }
  
  @Builder
  KeySection(title: string, category: string) {
    Column() {
      Text(title)
        .fontSize(10)
        .fontColor('#555')
        .width('100%')
        .margin({ bottom: 3, top: 4 })
      
      Flex({ wrap: FlexWrap.Wrap }) {
        ForEach(this.getKeysByCategory(category), (key: KeyOption) => {
          this.KeyButton(key)
        })
      }
    }
  }
  
  @Builder
  KeyButton(key: KeyOption) {
    Text(key.shortName)
      .fontSize(10)
      .fontColor(this.selectedKeys.includes(key.code) ? '#B8CCD0' : '#AAA')  // èŽ«å…°è¿ªæ·¡è“
      .padding({ left: 6, right: 6, top: 4, bottom: 4 })
      .backgroundColor(this.selectedKeys.includes(key.code) ? '#334ECDC4' : '#333')
      .borderRadius(4)
      .margin({ right: 4, bottom: 4 })
      .onClick(() => {
        if (this.selectedKeys.includes(key.code)) {
          this.selectedKeys = this.selectedKeys.filter(k => k !== key.code);
        } else if (this.selectedKeys.length < 4) {
          this.selectedKeys = [...this.selectedKeys, key.code];
        }
      })
  }
  
  private getKeyName(code: number): string {
    const key = this.availableKeys.find(k => k.code === code);
    return key ? key.shortName : `0x${code.toString(16)}`;
  }
  
  private getKeysByCategory(category: string): KeyOption[] {
    switch (category) {
      case 'modifier':
        return this.availableKeys.filter(k => 
          [0x11, 0x12, 0x10, 0x5B].includes(k.code));
      case 'function':
        return this.availableKeys.filter(k => 
          [0x1B, 0x09, 0x2E, 0x0D, 0x08, 0x20, 0x2D, 0x24, 0x23, 0x21, 0x22, 0x2C, 0x91, 0x13, 0x14, 0x90].includes(k.code));
      case 'arrow':
        return this.availableKeys.filter(k => 
          [0x25, 0x26, 0x27, 0x28].includes(k.code));
      case 'fkey':
        return this.availableKeys.filter(k => 
          k.code >= 0x70 && k.code <= 0x7B);
      case 'letter':
        return this.availableKeys.filter(k => 
          k.code >= 0x41 && k.code <= 0x5A);
      case 'number':
        return this.availableKeys.filter(k => 
          k.code >= 0x30 && k.code <= 0x39);
      case 'numpad':
        return this.availableKeys.filter(k => 
          k.code >= 0x60 && k.code <= 0x6F);
      case 'symbol':
        return this.availableKeys.filter(k => 
          [0xBA, 0xBB, 0xBC, 0xBD, 0xBE, 0xBF, 0xC0, 0xDB, 0xDC, 0xDD, 0xDE].includes(k.code));
      case 'media':
        return this.availableKeys.filter(k => 
          [0xAD, 0xAE, 0xAF, 0xB0, 0xB1, 0xB2, 0xB3].includes(k.code));
      default:
        return [];
    }
  }
  
  private canSave(): boolean {
    return this.name.trim().length > 0 && this.selectedKeys.length > 0;
  }
}
