/*
 * Moonlight for HarmonyOS
 * Copyright (C) 2024-2025 Moonlight/AlkaidLab
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 */

/**
 * Game Controller Kit æµ‹è¯•è§†å›¾
 * ç”¨äºæµ‹è¯•è“ç‰™/ç³»ç»Ÿæ‰‹æŸ„çš„è¾“å…¥ï¼ˆé USB ç›´è¿æ¨¡å¼ï¼‰
 */

import { gameControllerService, GameControllerService, ButtonCode } from '../service/GameControllerService';
import { AppColors } from '../common/Theme';

// æ‰‹æŸ„çŠ¶æ€ç±»
class ControllerInputState {
  buttons: number = 0;
  leftStickX: number = 0;
  leftStickY: number = 0;
  rightStickX: number = 0;
  rightStickY: number = 0;
  leftTrigger: number = 0;
  rightTrigger: number = 0;
}

// è®¾å¤‡ä¿¡æ¯ç±»
class GCDeviceInfo {
  deviceId: string = '';
  name: string = '';
  productId: number = 0;
}

// æŒ‰é”®äº‹ä»¶å†å²è®°å½•
class ButtonEventLog {
  timestamp: string;
  deviceId: string;
  buttonCode: number;
  buttonName: string;
  isPressed: boolean;
  
  constructor(deviceId: string, buttonCode: number, isPressed: boolean) {
    this.timestamp = new Date().toLocaleTimeString();
    this.deviceId = deviceId;
    this.buttonCode = buttonCode;
    this.buttonName = ButtonEventLog.getButtonName(buttonCode);
    this.isPressed = isPressed;
  }
  
  static getButtonName(code: number): string {
    // æ ¹æ®å®é™…æµ‹è¯•è°ƒæ•´çš„æ˜ å°„
    switch (code) {
      case 2301: return 'A';
      case 2302: return 'B';
      case 2303: return 'C';
      case 2304: return 'X';
      case 2305: return 'Y';
      case 2306: return 'Z';
      case 2307: return 'L1';
      case 2308: return 'R1';
      case 2309: return 'LT (æŒ‰é’®)';
      case 2310: return 'RT (æŒ‰é’®)';
      case 2311: return 'Select';
      case 2312: return 'Start';
      case 2313: return 'Home/Mode (å¯è‡ªå®šä¹‰)';  // è®¾ç½® â†’ æ‰‹æŸ„ â†’ Home é”®åŠ¨ä½œ
      case 2314: return 'L3';
      case 2315: return 'R3';
      // D-Pad
      case 2012: return 'D-Up';
      case 2013: return 'D-Down';
      case 2014: return 'D-Left';
      case 2015: return 'D-Right';
      default: return `æœªçŸ¥(${code})`;
    }
  }
}

@Component
export struct GameControllerTestView {
  @State isMonitoring: boolean = false;
  @State isAvailable: boolean = false;
  @State connectedDevices: GCDeviceInfo[] = [];
  @State inputStates: Map<string, ControllerInputState> = new Map();
  @State logMessages: string[] = [];
  @State buttonEventLogs: ButtonEventLog[] = [];
  @State rawButtonEvents: string[] = [];
  @State keyEventLogs: string[] = [];  // æ–°å¢ï¼šKeyEvent æ—¥å¿—
  
  // æ¥æ”¶æ¥è‡ªçˆ¶ç»„ä»¶çš„ KeyEvent å¤„ç†å™¨æ³¨å†Œå‡½æ•°
  onKeyEventRef?: (handler: (event: KeyEvent) => boolean) => void;
  
  private originalDeviceCallback: ((deviceId: string, isConnected: boolean, info: object | null) => void) | null = null;
  private originalButtonCallback: ((deviceId: string, buttonCode: number, isPressed: boolean) => void) | null = null;
  private originalAxisCallback: ((deviceId: string, axisType: number, x: number, y: number) => void) | null = null;

  aboutToAppear(): void {
    this.addLog('Game Controller Kit æµ‹è¯•è§†å›¾åˆå§‹åŒ–');
    this.checkAvailability();
    
    // æ³¨å†Œ KeyEvent å¤„ç†å™¨
    if (this.onKeyEventRef) {
      this.onKeyEventRef((event: KeyEvent) => this.handleKeyEvent(event));
    }
  }

  aboutToDisappear(): void {
    this.stopMonitoring();
  }
  
  /**
   * å¤„ç† KeyEvent (API 15+ æ”¯æŒ 2311-2315 æ‰‹æŸ„æŒ‰é”®)
   * æ³¨æ„ï¼šGC Kit ä¸æ”¯æŒ 2313 (Mode)ï¼Œåªèƒ½é€šè¿‡ KeyEvent æ•è·
   */
  private handleKeyEvent(event: KeyEvent): boolean {
    const keyCode = event.keyCode;
    // KeyType.Down = 0, KeyType.Up = 1
    const isPressed = event.type === 0;
    const timestamp = new Date().toLocaleTimeString();
    
    // è®°å½•æ‰€æœ‰ 2300+ èŒƒå›´çš„æŒ‰é”®ï¼ˆæ‰‹æŸ„ç›¸å…³ï¼‰
    if (keyCode >= 2300 && keyCode <= 2320) {
      const buttonName = ButtonEventLog.getButtonName(keyCode);
      const logEntry = `[${timestamp}] KeyEvent: code=${keyCode} (${buttonName}) ${isPressed ? 'æŒ‰ä¸‹' : 'é‡Šæ”¾'}`;
      this.keyEventLogs = [logEntry, ...this.keyEventLogs.slice(0, 29)];
      this.addLog(`KeyEvent: ${keyCode} (${buttonName}) ${isPressed ? 'æŒ‰ä¸‹' : 'é‡Šæ”¾'}`);
      
      // ç‰¹åˆ«æ ‡è®° 2313
      if (keyCode === 2313) {
        this.addLog(`â­ æ”¶åˆ° 2313 (Mode) æŒ‰é”®ï¼GC Kit ä¸æ”¯æŒæ­¤æŒ‰é”®ï¼Œé€šè¿‡ KeyEvent æ•è·`);
      }
      
      return true;  // å·²å¤„ç†
    }
    
    return false;  // æœªå¤„ç†
  }
  
  private checkAvailability(): void {
    this.isAvailable = gameControllerService.isAvailable();
    this.addLog(`Game Controller Kit å¯ç”¨æ€§: ${this.isAvailable ? 'å¯ç”¨' : 'ä¸å¯ç”¨'}`);
    
    if (this.isAvailable) {
      this.addLog('å¯ä»¥æµ‹è¯•è“ç‰™/ç³»ç»Ÿæ‰‹æŸ„è¾“å…¥');
    } else {
      this.addLog('è­¦å‘Š: Game Controller Kit ä¸å¯ç”¨ï¼Œå¯èƒ½éœ€è¦ API 21+');
    }
  }

  addLog(message: string): void {
    const timestamp = new Date().toLocaleTimeString();
    this.logMessages = [`[${timestamp}] ${message}`, ...this.logMessages.slice(0, 99)];
  }
  
  private addButtonEventLog(deviceId: string, buttonCode: number, isPressed: boolean): void {
    const log = new ButtonEventLog(deviceId, buttonCode, isPressed);
    this.buttonEventLogs = [log, ...this.buttonEventLogs.slice(0, 49)];
    this.rawButtonEvents = [`[${log.timestamp}] ${isPressed ? 'æŒ‰ä¸‹' : 'é‡Šæ”¾'} buttonCode=${buttonCode} (${log.buttonName})`, 
                            ...this.rawButtonEvents.slice(0, 29)];
  }
  
  private startMonitoring(): void {
    if (!this.isAvailable) {
      this.addLog('é”™è¯¯: Game Controller Kit ä¸å¯ç”¨');
      return;
    }
    
    if (this.isMonitoring) {
      this.addLog('å·²åœ¨ç›‘å¬ä¸­');
      return;
    }
    
    // åˆå§‹åŒ–
    if (!gameControllerService.init()) {
      this.addLog('é”™è¯¯: åˆå§‹åŒ–å¤±è´¥');
      return;
    }
    
    // è®¾ç½®å›è°ƒ
    gameControllerService.setDeviceCallback((deviceId, isConnected, info) => {
      this.onDeviceChanged(deviceId, isConnected, info);
    });
    
    gameControllerService.setButtonCallback((deviceId, buttonCode, isPressed) => {
      this.onButtonEvent(deviceId, buttonCode, isPressed);
    });
    
    gameControllerService.setAxisCallback((deviceId, axisType, x, y) => {
      this.handleAxisEvent(deviceId, axisType, x, y);
    });
    
    // å¼€å§‹ç›‘å¬
    if (!gameControllerService.startMonitor()) {
      this.addLog('é”™è¯¯: å¼€å§‹ç›‘å¬å¤±è´¥');
      return;
    }
    
    this.isMonitoring = true;
    this.addLog('å¼€å§‹ç›‘å¬ Game Controller Kit äº‹ä»¶');
    
    // è·å–å·²è¿æ¥è®¾å¤‡
    this.refreshConnectedDevices();
  }
  
  private stopMonitoring(): void {
    if (!this.isMonitoring) return;
    
    gameControllerService.stopMonitor();
    this.isMonitoring = false;
    this.addLog('åœæ­¢ç›‘å¬');
  }
  
  private refreshConnectedDevices(): void {
    const devices = gameControllerService.getAllDevices();
    this.connectedDevices = [];
    
    for (const device of devices) {
      const info = new GCDeviceInfo();
      info.deviceId = device.deviceId;
      info.name = device.name;
      info.productId = device.product;
      this.connectedDevices.push(info);
      this.addLog(`å‘ç°è®¾å¤‡: ${device.name} (ID: ${device.deviceId})`);
    }
    
    if (this.connectedDevices.length === 0) {
      this.addLog('æœªå‘ç°å·²è¿æ¥çš„æ‰‹æŸ„è®¾å¤‡');
    }
  }
  
  private onDeviceChanged(deviceId: string, isConnected: boolean, info: object | null): void {
    if (isConnected) {
      this.addLog(`è®¾å¤‡è¿æ¥: ${deviceId}`);
      this.refreshConnectedDevices();
    } else {
      this.addLog(`è®¾å¤‡æ–­å¼€: ${deviceId}`);
      this.connectedDevices = this.connectedDevices.filter(d => d.deviceId !== deviceId);
      this.inputStates.delete(deviceId);
    }
  }
  
  private onButtonEvent(deviceId: string, buttonCode: number, isPressed: boolean): void {
    // è®°å½•åŸå§‹äº‹ä»¶
    this.addButtonEventLog(deviceId, buttonCode, isPressed);
    this.addLog(`æŒ‰é”®äº‹ä»¶: device=${deviceId}, code=${buttonCode}, pressed=${isPressed}`);
    
    // æ›´æ–°çŠ¶æ€
    let state = this.inputStates.get(deviceId);
    if (!state) {
      state = new ControllerInputState();
      this.inputStates.set(deviceId, state);
    }
    
    const flag = this.buttonCodeToFlag(buttonCode);
    if (flag !== 0) {
      if (isPressed) {
        state.buttons |= flag;
      } else {
        state.buttons &= ~flag;
      }
      // è§¦å‘æ›´æ–°
      this.inputStates = new Map(this.inputStates);
    }
  }
  
  private buttonCodeToFlag(code: number): number {
    switch (code) {
      case 2301: return 0x1000;  // A
      case 2302: return 0x2000;  // B
      case 2303: return 0x0020;  // C -> BACK/Select
      case 2304: return 0x4000;  // X
      case 2305: return 0x8000;  // Y
      case 2306: return 0x0100;  // L1
      case 2307: return 0x0200;  // R1
      case 2310: return 0x0040;  // L3
      case 2311: return 0x0080;  // R3
      case 2312: return 0x0010;  // Menu -> START
      case 2313: return 0x0020;  // View -> BACK (å®˜æ–¹ä¸æ”¯æŒ)
      case 2314: return 0x0400;  // Home -> SPECIAL
      case 2315: return 0x0001;  // D-Up
      case 2316: return 0x0002;  // D-Down
      case 2317: return 0x0004;  // D-Left
      case 2318: return 0x0008;  // D-Right
      default: return 0;
    }
  }
  
  private handleAxisEvent(deviceId: string, axisType: number, x: number, y: number): void {
    let state = this.inputStates.get(deviceId);
    if (!state) {
      state = new ControllerInputState();
      this.inputStates.set(deviceId, state);
    }
    
    // AxisType: 0=å·¦æ‘‡æ†, 1=å³æ‘‡æ†, 2=D-Pad, 3=å·¦æ‰³æœº, 4=å³æ‰³æœº
    switch (axisType) {
      case 0: // å·¦æ‘‡æ†
        state.leftStickX = Math.round(x * 32767);
        state.leftStickY = Math.round(-y * 32767);
        break;
      case 1: // å³æ‘‡æ†
        state.rightStickX = Math.round(x * 32767);
        state.rightStickY = Math.round(-y * 32767);
        break;
      case 3: // å·¦æ‰³æœº
        state.leftTrigger = Math.round(x * 255);
        break;
      case 4: // å³æ‰³æœº
        state.rightTrigger = Math.round(x * 255);
        break;
    }
    
    // è§¦å‘æ›´æ–°
    this.inputStates = new Map(this.inputStates);
  }

  private formatStickValue(value: number): string {
    const percent = Math.round((value / 32767) * 100);
    if (percent > 0) {
      return `+${percent}%`;
    }
    return `${percent}%`;
  }

  private isButtonPressed(buttons: number, flag: number): boolean {
    return (buttons & flag) !== 0;
  }

  build() {
    Scroll() {
      Column({ space: 16 }) {
        // çŠ¶æ€æ ‡é¢˜
        Row({ space: 8 }) {
          Circle()
            .width(12)
            .height(12)
            .fill(this.isAvailable ? (this.isMonitoring ? AppColors.Success : AppColors.Warning) : AppColors.Error)
          Text(this.isAvailable ? (this.isMonitoring ? 'ç›‘å¬ä¸­' : 'å°±ç»ª') : 'ä¸å¯ç”¨')
            .fontSize(14)
            .fontColor(AppColors.TextPrimary)
        }
        
        // æ§åˆ¶æŒ‰é’®
        Row({ space: 12 }) {
          Button(this.isMonitoring ? 'åœæ­¢ç›‘å¬' : 'å¼€å§‹ç›‘å¬')
            .onClick(() => {
              if (this.isMonitoring) {
                this.stopMonitoring();
              } else {
                this.startMonitoring();
              }
            })
            .backgroundColor(this.isMonitoring ? AppColors.Error : AppColors.Success)
            .fontColor(AppColors.TextOnPrimary)
            .fontSize(14)
            .height(40)
            .padding({ left: 20, right: 20 })
            .borderRadius(20)
            .enabled(this.isAvailable)

          Button('åˆ·æ–°è®¾å¤‡')
            .onClick(() => {
              this.refreshConnectedDevices();
            })
            .backgroundColor(AppColors.Primary)
            .fontColor(AppColors.TextOnPrimary)
            .fontSize(14)
            .height(40)
            .padding({ left: 20, right: 20 })
            .borderRadius(20)
            .enabled(this.isMonitoring)
        }

        // å·²è¿æ¥è®¾å¤‡
        Column({ space: 8 }) {
          Text(`å·²è¿æ¥è®¾å¤‡ (${this.connectedDevices.length})`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(AppColors.TextPrimary)
            .width('100%')

          if (this.connectedDevices.length === 0) {
            Text('æœªæ£€æµ‹åˆ°æ‰‹æŸ„è®¾å¤‡\nè¯·ç¡®ä¿è“ç‰™æ‰‹æŸ„å·²é…å¯¹è¿æ¥')
              .fontSize(13)
              .fontColor(AppColors.TextSecondary)
              .textAlign(TextAlign.Center)
              .padding(16)
          } else {
            ForEach(this.connectedDevices, (device: GCDeviceInfo) => {
              Row({ space: 8 }) {
                Text('ğŸ®')
                  .fontSize(20)
                Column({ space: 2 }) {
                  Text(device.name)
                    .fontSize(14)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(AppColors.TextPrimary)
                  Text(`ID: ${device.deviceId}`)
                    .fontSize(11)
                    .fontColor(AppColors.TextTertiary)
                  if (device.productId !== 0) {
                    Text(`PID:0x${device.productId.toString(16).toUpperCase()}`)
                      .fontSize(10)
                      .fontColor(AppColors.TextTertiary)
                  }
                }
                .alignItems(HorizontalAlign.Start)
              }
              .width('100%')
              .padding(12)
              .backgroundColor(AppColors.SurfaceTransparent)
              .borderRadius(8)
            })
          }
        }
        .width('100%')
        .padding(12)
        .backgroundColor(AppColors.Surface)
        .borderRadius(12)

        // åŸå§‹æŒ‰é”®äº‹ä»¶ï¼ˆé‡è¦è¯Šæ–­ä¿¡æ¯ï¼‰
        Column({ space: 8 }) {
          Row() {
            Text('ğŸ”‘ åŸå§‹æŒ‰é”®äº‹ä»¶')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(AppColors.TextPrimary)
            Blank()
            Text('æŒ‰æ‰‹æŸ„æŒ‰é”®æŸ¥çœ‹ç å€¼')
              .fontSize(11)
              .fontColor(AppColors.TextTertiary)
          }
          .width('100%')

          if (this.rawButtonEvents.length === 0) {
            Text('ç­‰å¾…æŒ‰é”®è¾“å…¥...\næŒ‰ä¸‹æ‰‹æŸ„ä¸Šçš„ä»»æ„æŒ‰é”®')
              .fontSize(13)
              .fontColor(AppColors.TextSecondary)
              .textAlign(TextAlign.Center)
              .padding(16)
          } else {
            ForEach(this.rawButtonEvents.slice(0, 10), (event: string, index: number) => {
              Text(event)
                .fontSize(12)
                .fontColor(index === 0 ? AppColors.Primary : AppColors.TextSecondary)
                .fontFamily('monospace')
                .width('100%')
                .padding({ top: 4, bottom: 4 })
            })
          }
        }
        .width('100%')
        .padding(12)
        .backgroundColor(AppColors.Surface)
        .borderRadius(12)

        // æŒ‰é”®çŠ¶æ€å¯è§†åŒ–
        if (this.connectedDevices.length > 0) {
          this.buildButtonsDisplay()
        }

        // æ—¥å¿—
        Column({ space: 8 }) {
          Text('ğŸ“‹ æ—¥å¿—')
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor(AppColors.TextPrimary)
            .width('100%')

          ForEach(this.logMessages.slice(0, 20), (log: string) => {
            Text(log)
              .fontSize(11)
              .fontColor(AppColors.TextSecondary)
              .width('100%')
              .padding({ top: 2, bottom: 2 })
          })
        }
        .width('100%')
        .padding(12)
        .backgroundColor(AppColors.Surface)
        .borderRadius(12)
      }
      .width('100%')
      .padding(16)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppColors.Background)
  }
  
  // è·å–ç¬¬ä¸€ä¸ªè®¾å¤‡çš„çŠ¶æ€
  private getFirstDeviceState(): ControllerInputState | null {
    if (this.connectedDevices.length > 0) {
      return this.inputStates.get(this.connectedDevices[0].deviceId) ?? null;
    }
    return null;
  }
  
  @Builder
  buildButtonsDisplay() {
    Column({ space: 8 }) {
      Text('ğŸ® æŒ‰é”®çŠ¶æ€')
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(AppColors.TextPrimary)
        .width('100%')

      if (this.getFirstDeviceState() === null) {
        Text('ç­‰å¾…è¾“å…¥...')
          .fontSize(13)
          .fontColor(AppColors.TextSecondary)
      } else {
        // æŒ‰é”®ç½‘æ ¼
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
          this.buildButtonIndicator('A', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x1000))
          this.buildButtonIndicator('B', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x2000))
          this.buildButtonIndicator('X', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x4000))
          this.buildButtonIndicator('Y', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x8000))
          this.buildButtonIndicator('LB', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x0100))
          this.buildButtonIndicator('RB', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x0200))
          this.buildButtonIndicator('LS', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x0040))
          this.buildButtonIndicator('RS', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x0080))
          this.buildButtonIndicator('Start', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x0010))
          this.buildButtonIndicator('Back', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x0020))
          this.buildButtonIndicator('Home', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x0400))
          this.buildButtonIndicator('â†‘', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x0001))
          this.buildButtonIndicator('â†“', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x0002))
          this.buildButtonIndicator('â†', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x0004))
          this.buildButtonIndicator('â†’', this.isButtonPressed(this.getFirstDeviceState()!.buttons, 0x0008))
        }
        .width('100%')

        // æ‘‡æ†å’Œæ‰³æœº
        Row({ space: 16 }) {
          Column({ space: 4 }) {
            Text('å·¦æ‘‡æ†')
              .fontSize(11)
              .fontColor(AppColors.TextSecondary)
            Text(`X: ${this.formatStickValue(this.getFirstDeviceState()!.leftStickX)}`)
              .fontSize(12)
              .fontColor(AppColors.TextPrimary)
            Text(`Y: ${this.formatStickValue(this.getFirstDeviceState()!.leftStickY)}`)
              .fontSize(12)
              .fontColor(AppColors.TextPrimary)
          }
          
          Column({ space: 4 }) {
            Text('å³æ‘‡æ†')
              .fontSize(11)
              .fontColor(AppColors.TextSecondary)
            Text(`X: ${this.formatStickValue(this.getFirstDeviceState()!.rightStickX)}`)
              .fontSize(12)
              .fontColor(AppColors.TextPrimary)
            Text(`Y: ${this.formatStickValue(this.getFirstDeviceState()!.rightStickY)}`)
              .fontSize(12)
              .fontColor(AppColors.TextPrimary)
          }
          
          Column({ space: 4 }) {
            Text('æ‰³æœº')
              .fontSize(11)
              .fontColor(AppColors.TextSecondary)
            Text(`LT: ${this.getFirstDeviceState()!.leftTrigger}`)
              .fontSize(12)
              .fontColor(AppColors.TextPrimary)
            Text(`RT: ${this.getFirstDeviceState()!.rightTrigger}`)
              .fontSize(12)
              .fontColor(AppColors.TextPrimary)
          }
        }
        .width('100%')
        .justifyContent(FlexAlign.SpaceEvenly)
        .margin({ top: 8 })
      }
    }
    .width('100%')
    .padding(12)
    .backgroundColor(AppColors.Surface)
    .borderRadius(12)
  }
  
  @Builder
  buildButtonIndicator(name: string, isPressed: boolean) {
    Text(name)
      .fontSize(12)
      .fontColor(isPressed ? AppColors.TextOnPrimary : AppColors.TextSecondary)
      .backgroundColor(isPressed ? AppColors.Success : AppColors.SurfaceDark)
      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
      .borderRadius(4)
      .margin(4)
  }
}
