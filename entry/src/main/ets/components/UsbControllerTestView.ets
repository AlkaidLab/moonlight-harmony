/*
 * Moonlight for HarmonyOS
 * Copyright (C) 2024-2025 Moonlight/AlkaidLab
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 */

/**
 * USB æ‰‹æŸ„æµ‹è¯•è§†å›¾
 * ç”¨äºæµ‹è¯• USB æ‰‹æŸ„é©±åŠ¨æ˜¯å¦æ­£å¸¸å·¥ä½œ
 */

import { usbManager } from '@kit.BasicServicesKit';
import { UsbDriverService, UsbDriverListener, ControllerType, AbstractController, ButtonFlags } from '../service/usbdriver';
import { AppColors } from '../common/Theme';

// æ‰‹æŸ„çŠ¶æ€ç±»
class ControllerInputState {
  buttons: number = 0;
  leftStickX: number = 0;
  leftStickY: number = 0;
  rightStickX: number = 0;
  rightStickY: number = 0;
  leftTrigger: number = 0;
  rightTrigger: number = 0;
}

// è®¾å¤‡ä¿¡æ¯ç±»
class DeviceInfo {
  name: string = '';
  vid: number = 0;
  pid: number = 0;
  type: number = 0;
}

// USB é©±åŠ¨ç›‘å¬å™¨å®ç°ç±»
class TestViewDriverListener implements UsbDriverListener {
  private view: UsbControllerTestView;
  
  constructor(view: UsbControllerTestView) {
    this.view = view;
  }
  
  reportControllerState(controllerId: number, buttonFlags: number,
    leftStickX: number, leftStickY: number,
    rightStickX: number, rightStickY: number,
    leftTrigger: number, rightTrigger: number): void {
    
    this.view.incrementPollCount();
    
    const state = new ControllerInputState();
    state.buttons = buttonFlags;
    state.leftStickX = Math.max(-32767, Math.min(32767, Math.round(leftStickX * 32767)));
    state.leftStickY = Math.max(-32767, Math.min(32767, Math.round(leftStickY * 32767)));
    state.rightStickX = Math.max(-32767, Math.min(32767, Math.round(rightStickX * 32767)));
    state.rightStickY = Math.max(-32767, Math.min(32767, Math.round(rightStickY * 32767)));
    state.leftTrigger = leftTrigger;
    state.rightTrigger = rightTrigger;
    
    this.view.updateInputState(state);
  }

  reportControllerMotion(controllerId: number, motionType: number,
    x: number, y: number, z: number): void {
  }

  deviceAdded(controller: AbstractController): void {
    this.view.onDeviceAdded(controller);
  }

  deviceRemoved(controller: AbstractController): void {
    this.view.onDeviceRemoved(controller);
  }
}

@Component
export struct UsbControllerTestView {
  @State isRunning: boolean = false;
  @State deviceCount: number = 0;
  @State connectedDevices: DeviceInfo[] = [];
  @State lastInputState: ControllerInputState | null = null;
  @State logMessages: string[] = [];
  @State pollRate: number = 0;
  @State pollCount: number = 0;

  private usbDriverService: UsbDriverService | null = null;
  private listener: TestViewDriverListener | null = null;
  private pollCountInternal: number = 0;
  private lastPollStatTime: number = 0;
  private pollRateTimer: number = -1;

  aboutToAppear(): void {
    this.addLog('USB æ‰‹æŸ„æµ‹è¯•è§†å›¾åˆå§‹åŒ–');
    this.checkUsbDevices();
    this.startPollRateTimer();
  }

  aboutToDisappear(): void {
    this.stopPollRateTimer();
    this.stopDriver();
  }
  
  private startPollRateTimer(): void {
    this.lastPollStatTime = Date.now();
    this.pollCountInternal = 0;
    
    this.pollRateTimer = setInterval(() => {
      const now = Date.now();
      const elapsed = (now - this.lastPollStatTime) / 1000;
      
      if (elapsed > 0) {
        this.pollRate = Math.round(this.pollCountInternal / elapsed);
        this.pollCount = this.pollCountInternal;
      }
      
      this.pollCountInternal = 0;
      this.lastPollStatTime = now;
    }, 1000);
  }
  
  private stopPollRateTimer(): void {
    if (this.pollRateTimer !== -1) {
      clearInterval(this.pollRateTimer);
      this.pollRateTimer = -1;
    }
  }
  
  incrementPollCount(): void {
    this.pollCountInternal++;
  }

  addLog(message: string): void {
    const timestamp: string = new Date().toLocaleTimeString();
    this.logMessages = [`[${timestamp}] ${message}`, ...this.logMessages.slice(0, 49)];
  }
  
  updateInputState(state: ControllerInputState): void {
    this.lastInputState = state;
  }
  
  onDeviceAdded(controller: AbstractController): void {
    this.addLog(`è®¾å¤‡å·²è¿æ¥: ${controller.getName()}`);
    const deviceInfo = new DeviceInfo();
    deviceInfo.name = controller.getName();
    deviceInfo.vid = controller.getVendorId();
    deviceInfo.pid = controller.getProductId();
    deviceInfo.type = controller.getControllerType();
    this.connectedDevices = [...this.connectedDevices, deviceInfo];
  }
  
  onDeviceRemoved(controller: AbstractController): void {
    this.addLog(`è®¾å¤‡å·²æ–­å¼€: ${controller.getName()}`);
    this.connectedDevices = [];
  }

  private checkUsbDevices(): void {
    try {
      const devices: usbManager.USBDevice[] = usbManager.getDevices();
      this.deviceCount = devices.length;
      this.addLog(`å‘ç° ${devices.length} ä¸ª USB è®¾å¤‡`);

      for (let i: number = 0; i < devices.length; i++) {
        const device: usbManager.USBDevice = devices[i];
        this.addLog(`è®¾å¤‡ ${i + 1}: VID=0x${device.vendorId.toString(16).toUpperCase()}, PID=0x${device.productId.toString(16).toUpperCase()}`);
      }
    } catch (err) {
      this.addLog(`æ£€æŸ¥è®¾å¤‡å¤±è´¥: ${err}`);
    }
  }

  private startDriver(): void {
    if (this.usbDriverService !== null) {
      return;
    }

    this.listener = new TestViewDriverListener(this);
    this.usbDriverService = UsbDriverService.getInstance();
    this.usbDriverService.setListener(this.listener);
    this.usbDriverService.start();
    this.isRunning = true;
    this.addLog('USB é©±åŠ¨æœåŠ¡å·²å¯åŠ¨');
  }

  private stopDriver(): void {
    if (this.usbDriverService !== null) {
      this.usbDriverService.stop();
      this.usbDriverService = null;
      this.listener = null;
      this.isRunning = false;
      this.connectedDevices = [];
      this.lastInputState = null;
      this.addLog('USB é©±åŠ¨æœåŠ¡å·²åœæ­¢');
    }
  }

  private getControllerTypeName(type: number): string {
    if (type === ControllerType.XBOX) {
      return 'Xbox';
    } else if (type === ControllerType.PS) {
      return 'PlayStation';
    } else if (type === ControllerType.NINTENDO) {
      return 'Nintendo';
    } else {
      return 'Generic';
    }
  }
  
  private getControllerTypeIcon(type: number): string {
    if (type === ControllerType.XBOX) {
      return 'ğŸ®';
    } else if (type === ControllerType.PS) {
      return 'ğŸ®';
    } else if (type === ControllerType.NINTENDO) {
      return 'ğŸ•¹ï¸';
    } else {
      return 'ğŸ®';
    }
  }
  
  private getPollRateColor(): ResourceColor {
    if (this.pollRate >= 250) {
      return AppColors.Success;
    } else if (this.pollRate >= 100) {
      return AppColors.Primary;
    } else if (this.pollRate >= 60) {
      return AppColors.Warning;
    } else {
      return AppColors.Error;
    }
  }
  
  private getPollRateDesc(): string {
    if (this.pollRate >= 500) {
      return 'ä¸“ä¸šçº§å“åº”';
    } else if (this.pollRate >= 250) {
      return 'æµç•…æ¸¸æˆ';
    } else if (this.pollRate >= 125) {
      return 'æ ‡å‡†å“åº”';
    } else if (this.pollRate >= 60) {
      return 'å¯èƒ½æœ‰å»¶è¿Ÿ';
    } else if (this.pollRate > 0) {
      return 'å“åº”è¾ƒæ…¢';
    } else {
      return 'ç­‰å¾…æ•°æ®';
    }
  }

  private formatStickValue(value: number): string {
    const percent = Math.round((value / 32767) * 100);
    if (percent > 0) {
      return `+${percent}%`;
    }
    return `${percent}%`;
  }
  
  private formatTriggerValue(value: number): string {
    return `${Math.round(value * 100)}%`;
  }

  private isButtonPressed(buttons: number, flag: number): boolean {
    return (buttons & flag) !== 0;
  }

  build() {
    Scroll() {
      Column({ space: 16 }) {
        // æ§åˆ¶æŒ‰é’®åŒº
        Row({ space: 12 }) {
          Button(this.isRunning ? 'åœæ­¢é©±åŠ¨' : 'å¯åŠ¨é©±åŠ¨')
            .onClick(() => {
              if (this.isRunning) {
                this.stopDriver();
              } else {
                this.startDriver();
              }
            })
            .backgroundColor(this.isRunning ? AppColors.Error : AppColors.Success)
            .fontColor(AppColors.TextOnPrimary)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .height(40)
            .padding({ left: 20, right: 20 })
            .borderRadius(20)

          Button('åˆ·æ–°è®¾å¤‡')
            .onClick(() => {
              this.checkUsbDevices();
            })
            .backgroundColor(AppColors.Primary)
            .fontColor(AppColors.TextOnPrimary)
            .fontSize(14)
            .fontWeight(FontWeight.Medium)
            .height(40)
            .padding({ left: 20, right: 20 })
            .borderRadius(20)
        }

        // è®¾å¤‡çŠ¶æ€å¡ç‰‡
        Column({ space: 12 }) {
          Row() {
            Text('ğŸ®')
              .fontSize(20)
            Text('è®¾å¤‡çŠ¶æ€')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(AppColors.TextPrimary)
              .margin({ left: 8 })
            Blank()
            // è®¾å¤‡æ•°é‡å¾½ç« 
            Text(`${this.deviceCount}`)
              .fontSize(12)
              .fontColor(AppColors.TextOnPrimary)
              .backgroundColor(AppColors.Primary)
              .padding({ left: 8, right: 8, top: 2, bottom: 2 })
              .borderRadius(10)
          }
          .width('100%')
          
          Row({ space: 16 }) {
            Column({ space: 4 }) {
              Text('USB è®¾å¤‡')
                .fontSize(12)
                .fontColor(AppColors.TextSecondary)
              Text(`${this.deviceCount}`)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor(AppColors.TextPrimary)
            }
            .alignItems(HorizontalAlign.Center)
            
            Divider()
              .vertical(true)
              .height(40)
              .color(AppColors.Divider)
            
            Column({ space: 4 }) {
              Text('å·²è¿æ¥æ‰‹æŸ„')
                .fontSize(12)
                .fontColor(AppColors.TextSecondary)
              Text(`${this.connectedDevices.length}`)
                .fontSize(24)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.connectedDevices.length > 0 ? AppColors.Success : AppColors.TextTertiary)
            }
            .alignItems(HorizontalAlign.Center)
            
            if (this.connectedDevices.length > 0) {
              Divider()
                .vertical(true)
                .height(40)
                .color(AppColors.Divider)
              
              Column({ space: 4 }) {
                Text('è½®è¯¢ç‡')
                  .fontSize(12)
                  .fontColor(AppColors.TextSecondary)
                Row() {
                  Text(`${this.pollRate}`)
                    .fontSize(24)
                    .fontWeight(FontWeight.Bold)
                    .fontColor(this.getPollRateColor())
                  Text(' Hz')
                    .fontSize(14)
                    .fontColor(AppColors.TextSecondary)
                }
              }
              .alignItems(HorizontalAlign.Center)
            }
          }
          .width('100%')
          .justifyContent(FlexAlign.SpaceEvenly)

          // å·²è¿æ¥è®¾å¤‡åˆ—è¡¨
          if (this.connectedDevices.length > 0) {
            Divider().color(AppColors.Divider)
            
            ForEach(this.connectedDevices, (device: DeviceInfo) => {
              Row({ space: 8 }) {
                Text(this.getControllerTypeIcon(device.type))
                  .fontSize(24)
                Column({ space: 2 }) {
                  Text(device.name)
                    .fontSize(14)
                    .fontWeight(FontWeight.Medium)
                    .fontColor(AppColors.TextPrimary)
                  Text(`${this.getControllerTypeName(device.type)} Â· VID:0x${device.vid.toString(16).toUpperCase()} PID:0x${device.pid.toString(16).toUpperCase()}`)
                    .fontSize(11)
                    .fontColor(AppColors.TextTertiary)
                }
                .alignItems(HorizontalAlign.Start)
                .layoutWeight(1)
                
                Text(this.getPollRateDesc())
                  .fontSize(11)
                  .fontColor(this.getPollRateColor())
                  .padding({ left: 8, right: 8, top: 4, bottom: 4 })
                  .backgroundColor(AppColors.SurfaceDark)
                  .borderRadius(4)
              }
              .width('100%')
              .padding(8)
              .backgroundColor(AppColors.SurfaceTransparent)
              .borderRadius(8)
            })
          }
        }
        .width('100%')
        .padding(16)
        .backgroundColor(AppColors.CardBackground)
        .borderRadius(12)
        .border({ width: 1, color: AppColors.CardBorder })

        // è¾“å…¥çŠ¶æ€å¡ç‰‡ - æ‰‹æŸ„å½¢çŠ¶å¯è§†åŒ–
        if (this.lastInputState !== null) {
          Column({ space: 12 }) {
            Row() {
              Text('ğŸ•¹ï¸')
                .fontSize(20)
              Text('è¾“å…¥çŠ¶æ€')
                .fontSize(16)
                .fontWeight(FontWeight.Bold)
                .fontColor(AppColors.TextPrimary)
                .margin({ left: 8 })
            }
            .width('100%')

            // æ‰‹æŸ„å¯è§†åŒ–é¢æ¿
            Column() {
              // é¡¶éƒ¨ï¼šæ‰³æœºå’Œè‚©é”®
              Row() {
                // å·¦æ‰³æœº LT
                Column({ space: 2 }) {
                  Text('LT')
                    .fontSize(10)
                    .fontColor(AppColors.TextSecondary)
                  this.TriggerBar(this.lastInputState!.leftTrigger, true)
                }
                // å·¦è‚©é”® LB
                this.ShoulderButton('LB', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.LB_FLAG))
                
                Blank()
                
                // å³è‚©é”® RB
                this.ShoulderButton('RB', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.RB_FLAG))
                // å³æ‰³æœº RT
                Column({ space: 2 }) {
                  Text('RT')
                    .fontSize(10)
                    .fontColor(AppColors.TextSecondary)
                  this.TriggerBar(this.lastInputState!.rightTrigger, false)
                }
              }
              .width('100%')
              .padding({ left: 16, right: 16 })
              
              // ä¸»ä½“éƒ¨åˆ†ï¼šæ‰‹æŸ„è½®å»“
              Row() {
                // å·¦åŠéƒ¨åˆ†ï¼šD-Pad + å·¦æ‘‡æ†
                Column({ space: 16 }) {
                  // å·¦æ‘‡æ†
                  Column({ space: 4 }) {
                    this.StickVisualizer(this.lastInputState!.leftStickX, this.lastInputState!.leftStickY, false)
                    Row() {
                      Text('L3')
                        .fontSize(9)
                        .fontColor(this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.LS_CLK_FLAG) ? 
                          AppColors.Primary : AppColors.TextTertiary)
                        .fontWeight(this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.LS_CLK_FLAG) ? 
                          FontWeight.Bold : FontWeight.Normal)
                    }
                  }
                  
                  // D-Pad
                  this.DPadVisualizer()
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Center)
                
                // ä¸­é—´éƒ¨åˆ†ï¼šåŠŸèƒ½é”®
                Column({ space: 12 }) {
                  // Back / Start
                  Row({ space: 16 }) {
                    this.FunctionButton('âª', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.BACK_FLAG))
                    this.FunctionButton('ğŸ ', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.SPECIAL_BUTTON_FLAG))
                    this.FunctionButton('â¯', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.PLAY_FLAG))
                  }
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Center)
                .justifyContent(FlexAlign.Center)
                
                // å³åŠéƒ¨åˆ†ï¼šABXY + å³æ‘‡æ†
                Column({ space: 16 }) {
                  // ABXY æŒ‰é’®ï¼ˆè±å½¢å¸ƒå±€ï¼‰
                  this.ABXYVisualizer()
                  
                  // å³æ‘‡æ†
                  Column({ space: 4 }) {
                    this.StickVisualizer(this.lastInputState!.rightStickX, this.lastInputState!.rightStickY, true)
                    Row() {
                      Text('R3')
                        .fontSize(9)
                        .fontColor(this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.RS_CLK_FLAG) ? 
                          AppColors.Error : AppColors.TextTertiary)
                        .fontWeight(this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.RS_CLK_FLAG) ? 
                          FontWeight.Bold : FontWeight.Normal)
                    }
                  }
                }
                .layoutWeight(1)
                .alignItems(HorizontalAlign.Center)
              }
              .width('100%')
              .padding(16)
            }
            .width('100%')
            .padding({ top: 12, bottom: 12 })
            .backgroundColor(AppColors.SurfaceTransparent)
            .borderRadius(16)
            
            // åº•éƒ¨æ•°å€¼æ˜¾ç¤º
            Row({ space: 16 }) {
              // å·¦æ‘‡æ†æ•°å€¼
              Column({ space: 2 }) {
                Text('å·¦æ‘‡æ†')
                  .fontSize(10)
                  .fontColor(AppColors.TextTertiary)
                Text(`${this.formatStickValue(this.lastInputState!.leftStickX)}, ${this.formatStickValue(this.lastInputState!.leftStickY)}`)
                  .fontSize(11)
                  .fontColor(AppColors.TextSecondary)
                  .fontFamily('monospace')
              }
              .alignItems(HorizontalAlign.Center)
              
              Divider().vertical(true).height(24).color(AppColors.Divider)
              
              // æ‰³æœºæ•°å€¼
              Column({ space: 2 }) {
                Text('æ‰³æœº')
                  .fontSize(10)
                  .fontColor(AppColors.TextTertiary)
                Text(`L:${this.formatTriggerValue(this.lastInputState!.leftTrigger)} R:${this.formatTriggerValue(this.lastInputState!.rightTrigger)}`)
                  .fontSize(11)
                  .fontColor(AppColors.TextSecondary)
                  .fontFamily('monospace')
              }
              .alignItems(HorizontalAlign.Center)
              
              Divider().vertical(true).height(24).color(AppColors.Divider)
              
              // å³æ‘‡æ†æ•°å€¼
              Column({ space: 2 }) {
                Text('å³æ‘‡æ†')
                  .fontSize(10)
                  .fontColor(AppColors.TextTertiary)
                Text(`${this.formatStickValue(this.lastInputState!.rightStickX)}, ${this.formatStickValue(this.lastInputState!.rightStickY)}`)
                  .fontSize(11)
                  .fontColor(AppColors.TextSecondary)
                  .fontFamily('monospace')
              }
              .alignItems(HorizontalAlign.Center)
            }
            .width('100%')
            .justifyContent(FlexAlign.SpaceEvenly)
          }
          .width('100%')
          .padding(16)
          .backgroundColor(AppColors.CardBackground)
          .borderRadius(12)
          .border({ width: 1, color: AppColors.CardBorder })
        }

        // æ—¥å¿—å¡ç‰‡
        Column({ space: 12 }) {
          Row() {
            Text('ğŸ“‹')
              .fontSize(20)
            Text('è°ƒè¯•æ—¥å¿—')
              .fontSize(16)
              .fontWeight(FontWeight.Bold)
              .fontColor(AppColors.TextPrimary)
              .margin({ left: 8 })
            Blank()
            Text(`${this.logMessages.length} æ¡`)
              .fontSize(12)
              .fontColor(AppColors.TextTertiary)
          }
          .width('100%')

          List() {
            ForEach(this.logMessages, (message: string, index: number) => {
              ListItem() {
                Text(message)
                  .fontSize(11)
                  .fontColor(AppColors.TextSecondary)
                  .fontFamily('monospace')
                  .width('100%')
              }
              .padding({ top: 4, bottom: 4 })
            })
          }
          .height(120)
          .width('100%')
          .backgroundColor(AppColors.SurfaceTransparent)
          .borderRadius(8)
          .padding(8)
        }
        .width('100%')
        .padding(16)
        .backgroundColor(AppColors.CardBackground)
        .borderRadius(12)
        .border({ width: 1, color: AppColors.CardBorder })
      }
      .padding(16)
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppColors.Background)
    .scrollBar(BarState.Off)
  }

  // æ‘‡æ†å¯è§†åŒ– - å®æ—¶åŠ¨ç”»
  @Builder
  StickVisualizer(x: number, y: number, isRight: boolean) {
    Stack() {
      // å¤–åœˆ
      Circle()
        .width(80)
        .height(80)
        .fill(AppColors.SurfaceDark)
        .stroke(AppColors.Border)
        .strokeWidth(2)
      
      // åå­—çº¿
      Line()
        .width(60)
        .height(1)
        .backgroundColor(AppColors.Divider)
      Line()
        .width(1)
        .height(60)
        .backgroundColor(AppColors.Divider)
      
      // æ­»åŒºåœˆ
      Circle()
        .width(16)
        .height(16)
        .fill(Color.Transparent)
        .stroke(AppColors.Divider)
        .strokeWidth(1)
      
      // ç§»åŠ¨è½¨è¿¹ (æ·¡åŒ–æ•ˆæœ)
      Circle()
        .width(8)
        .height(8)
        .fill(isRight ? '#E8112320' : '#3D8ECF20')
        .offset({
          x: (x / 32767) * 30,
          y: -(y / 32767) * 30
        })
        .animation({ duration: 150, curve: Curve.EaseOut })
      
      // æŒ‡ç¤ºç‚¹ - æ·»åŠ å¹³æ»‘åŠ¨ç”»
      Circle()
        .width(16)
        .height(16)
        .fill(isRight ? AppColors.Error : AppColors.Primary)
        .shadow({ radius: 8, color: isRight ? '#E8112360' : '#3D8ECF60', offsetX: 0, offsetY: 0 })
        .offset({
          x: (x / 32767) * 30,
          y: -(y / 32767) * 30
        })
        .animation({ duration: 50, curve: Curve.Linear })  // å¿«é€Ÿå“åº”
    }
    .width(80)
    .height(80)
  }

  // æ‰³æœºæ¡ - å®æ—¶åŠ¨ç”»
  @Builder
  TriggerBar(value: number, isLeft: boolean) {
    Stack({ alignContent: Alignment.Bottom }) {
      // èƒŒæ™¯
      Column()
        .width(24)
        .height(60)
        .backgroundColor(AppColors.SurfaceDark)
        .borderRadius(12)
      
      // å‘å…‰å±‚ (value > 0 æ—¶æ˜¾ç¤º)
      if (value > 0.1) {
        Column()
          .width(24)
          .height(Math.max(4, value * 60))
          .backgroundColor(isLeft ? '#3D8ECF40' : '#E8112340')
          .borderRadius(12)
          .animation({ duration: 80, curve: Curve.EaseOut })
      }
      
      // å¡«å…… - æ·»åŠ å¹³æ»‘åŠ¨ç”»
      Column()
        .width(24)
        .height(Math.max(4, value * 60))
        .backgroundColor(isLeft ? AppColors.Primary : AppColors.Error)
        .borderRadius(12)
        .animation({ duration: 50, curve: Curve.Linear })  // å¿«é€Ÿå“åº”
    }
    .width(24)
    .height(60)
  }
  
  // è‚©é”®æŒ‰é’® - å¸¦æŒ‰ä¸‹åŠ¨ç”»
  @Builder
  ShoulderButton(label: string, pressed: boolean) {
    Column() {
      Text(label)
        .fontSize(12)
        .fontWeight(FontWeight.Medium)
        .fontColor(pressed ? '#FFFFFF' : AppColors.TextTertiary)
    }
    .width(48)
    .height(24)
    .borderRadius(12)
    .backgroundColor(pressed ? AppColors.Primary : AppColors.SurfaceDark)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .margin({ left: 8, right: 8 })
    .scale({ x: pressed ? 0.95 : 1, y: pressed ? 0.95 : 1 })
    .animation({ duration: 60 })
  }
  
  // åŠŸèƒ½é”®ï¼ˆBack/Start/Homeï¼‰- å¸¦æŒ‰ä¸‹åŠ¨ç”»
  @Builder
  FunctionButton(label: string, pressed: boolean) {
    Column() {
      Text(label)
        .fontSize(14)
        .fontColor(pressed ? '#FFFFFF' : AppColors.TextTertiary)
    }
    .width(32)
    .height(32)
    .borderRadius(16)
    .backgroundColor(pressed ? AppColors.Primary : AppColors.SurfaceDark)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .scale({ x: pressed ? 0.9 : 1, y: pressed ? 0.9 : 1 })
    .animation({ duration: 80 })
  }
  
  // ABXY æŒ‰é’®è±å½¢å¸ƒå±€
  @Builder
  ABXYVisualizer() {
    Column({ space: 2 }) {
      // Y åœ¨ä¸Š
      this.ABXYButton('Y', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.Y_FLAG), '#FFB900')
      
      // X å’Œ B åœ¨ä¸­é—´
      Row({ space: 24 }) {
        this.ABXYButton('X', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.X_FLAG), '#0078D4')
        this.ABXYButton('B', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.B_FLAG), '#E81123')
      }
      
      // A åœ¨ä¸‹
      this.ABXYButton('A', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.A_FLAG), '#107C10')
    }
  }
  
  // å•ä¸ª ABXY æŒ‰é’® - å¸¦æŒ‰ä¸‹åŠ¨ç”»
  @Builder
  ABXYButton(label: string, pressed: boolean, color: string) {
    Column() {
      Text(label)
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor(pressed ? '#FFFFFF' : AppColors.TextTertiary)
    }
    .width(36)
    .height(36)
    .borderRadius(18)
    .backgroundColor(pressed ? color : AppColors.SurfaceDark)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .shadow(pressed ? { radius: 12, color: color, offsetX: 0, offsetY: 2 } : undefined)
    .scale({ x: pressed ? 1.15 : 1, y: pressed ? 1.15 : 1 })
    .animation({ duration: 60 })
  }
  
  // D-Pad åå­—é”®å¯è§†åŒ–
  @Builder
  DPadVisualizer() {
    Column({ space: 2 }) {
      // ä¸Š
      this.DPadArrow('â–²', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.UP_FLAG))
      
      // å·¦ ä¸­å¿ƒ å³
      Row({ space: 2 }) {
        this.DPadArrow('â—€', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.LEFT_FLAG))
        // ä¸­å¿ƒå ä½
        Column()
          .width(28)
          .height(28)
          .backgroundColor(AppColors.SurfaceDark)
          .borderRadius(4)
        this.DPadArrow('â–¶', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.RIGHT_FLAG))
      }
      
      // ä¸‹
      this.DPadArrow('â–¼', this.isButtonPressed(this.lastInputState!.buttons, ButtonFlags.DOWN_FLAG))
    }
  }
  
  // D-Pad å•ä¸ªæ–¹å‘é”® - å¸¦æŒ‰ä¸‹åŠ¨ç”»
  @Builder
  DPadArrow(label: string, pressed: boolean) {
    Column() {
      Text(label)
        .fontSize(12)
        .fontColor(pressed ? '#FFFFFF' : AppColors.TextTertiary)
    }
    .width(28)
    .height(28)
    .borderRadius(4)
    .backgroundColor(pressed ? AppColors.Primary : AppColors.SurfaceDark)
    .justifyContent(FlexAlign.Center)
    .alignItems(HorizontalAlign.Center)
    .scale({ x: pressed ? 1.1 : 1, y: pressed ? 1.1 : 1 })
    .animation({ duration: 60 })
  }
}
