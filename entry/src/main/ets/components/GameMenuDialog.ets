/*
 * Moonlight for HarmonyOS
 * Copyright (C) 2024-2025 Moonlight/AlkaidLab
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 */

/**
 * ä¸²æµæ¸¸æˆèœå•å¼¹çª— - å¥¶æ²¹é£æ ¼ + é€æ˜ç»ç’ƒæ•ˆæœ
 * 
 * è®¾è®¡ç†å¿µï¼š
 * - é©¬å¡é¾™é…è‰²çš„é•¿ç­’è¢œå½¢çŠ¶æŒ‰é’®
 * - ä»å³è¾¹ä¾æ¬¡å¼¹å‡ºçš„åŠ¨ç”»æ•ˆæœ
 * - äºŒçº§èœå•å…¨å±å±…ä¸­æ˜¾ç¤º
 * - å¥¶æ²¹é£å¡ç‰‡ï¼šåŠé€æ˜æ¯›ç»ç’ƒ + æ·¡é›…é…è‰²
 * - è¶…çº§æŒ‡ä»¤é¢æ¿ (Sunshine åŠŸèƒ½)
 */
import { promptAction } from '@kit.ArkUI';
import { StreamViewModel } from '../viewmodel/StreamViewModel';
import { VirtualKey } from './StreamMenuManager';
import { ShortcutManager, Shortcut } from './ShortcutManager';
import { ActionDialog, ActionDialogConfig, ConfirmDialog, ConfirmDialogConfig } from './ConfirmDialog';
import { SuperCmd } from '../service/NvHttp';

/**
 * èœå•å›è°ƒæ¥å£
 */
export interface GameMenuCallbacks {
  onDismiss: () => void;
  onDisconnect: () => void;
  onQuitGame: () => void;
  onTouchModeChanged: (mode: string) => void;
  onOpenShortcutEditor?: () => void;
  onEditShortcut?: (shortcut: Shortcut) => void;     // ç¼–è¾‘å¿«æ·é”®
  onDeleteShortcut?: (shortcut: Shortcut) => void;   // åˆ é™¤å¿«æ·é”®
  onSendSuperCmd?: (cmdId: string) => void;  // å‘é€è¶…çº§æŒ‡ä»¤
  onForceUsbDriver?: () => void;  // å¼ºåˆ¶ USB é©±åŠ¨æ¥ç®¡
  onClose?: () => void; // ç”¨äºå…³é—­å¯¹è¯æ¡†
}

/**
 * èœå•é¡¹é…ç½®
 */
interface MenuItem {
  icon: string;
  label: string;
  bgColor: string;      // è¢œç­’é¢œè‰²ï¼ˆæµ…ï¼‰
  borderColor: string;  // è¢œå¤´å’Œè•¾ä¸é¢œè‰²ï¼ˆæ·±ï¼‰
}

@CustomDialog
export struct GameMenuDialog {
  controller: CustomDialogController;
  viewModel: StreamViewModel = new StreamViewModel();
  callbacks: GameMenuCallbacks = {
    onDismiss: () => {},
    onDisconnect: () => {},
    onQuitGame: () => {},
    onTouchModeChanged: () => {}
  };
  superCmds: SuperCmd[] = [];  // è¶…çº§æŒ‡ä»¤åˆ—è¡¨ (Sunshine åŠŸèƒ½)
  
  // èœå•é¡¹é…ç½®ï¼ˆé©¬å¡é¾™è‰²ç³» - ä¼˜åŒ–é…è‰²å’Œå›¾æ ‡ï¼‰
  private readonly menuItems: MenuItem[] = [
    { icon: 'âŠ', label: 'Win', bgColor: '#C7E5F7', borderColor: '#5BA3D0' },       // Windows é”®
    { icon: 'â—', label: 'USBé©±åŠ¨', bgColor: '#F7D1D1', borderColor: '#D87070' },   // USB é©±åŠ¨æ¥ç®¡
    { icon: 'âœ¦', label: 'HDR', bgColor: '#F7EBC7', borderColor: '#D0A850' },       // HDR
    { icon: 'âŒ¨', label: 'é”®ç›˜', bgColor: '#C7F7E0', borderColor: '#50C080' },      // é”®ç›˜
    { icon: 'â˜', label: 'è§¦æ§', bgColor: '#E0D4F7', borderColor: '#9080C0' },      // è§¦æ§
    { icon: 'â—', label: 'ä¼‘çœ ', bgColor: '#E8E8E8', borderColor: '#909090' },      // ä¼‘çœ 
    { icon: 'âœ•', label: 'é€€å‡º', bgColor: '#F7CFCF', borderColor: '#D06060' }       // é€€å‡º
  ];
  
  // èœå•é¡¹æ°´å¹³åç§»ï¼ˆä¸è§„åˆ™æ’åˆ—ï¼‰
  private readonly offsets: number[] = [15, 55, 25, 70, 35, 10, 50];
  
  // åŠ¨ç”»çŠ¶æ€ï¼štranslateX ä½ç½®ï¼ˆæ­£å€¼å‘å³ï¼Œè´Ÿå€¼å‘å·¦ï¼‰
  @State private pos0: number = 200;  // åˆå§‹åœ¨å±å¹•å³è¾¹å¤–é¢
  @State private pos1: number = 200;
  @State private pos2: number = 200;
  @State private pos3: number = 200;
  @State private pos4: number = 200;
  @State private pos5: number = 200;
  @State private pos6: number = 200;
  
  // åŠ¨ç”»çŠ¶æ€ï¼šç¼©æ”¾ï¼ˆåˆå§‹ä¸º 1.0ï¼Œä¸ç¼©å°ï¼‰
  @State private scale0: number = 1.0;
  @State private scale1: number = 1.0;
  @State private scale2: number = 1.0;
  @State private scale3: number = 1.0;
  @State private scale4: number = 1.0;
  @State private scale5: number = 1.0;
  @State private scale6: number = 1.0;
  
  // äºŒçº§èœå•çŠ¶æ€
  @State private expandedMenu: string = '';
  
  // å¿«æ·é”®
  @State private shortcuts: Shortcut[] = [];
  private shortcutManager = ShortcutManager.getInstance();
  
  // ç ç‡è°ƒæ•´çŠ¶æ€
  @State private currentBitrate: number = 0;  // å½“å‰ç ç‡ (kbps)
  @State private bitrateSliderValue: number = 0;  // æ»‘å—å€¼
  @State private isAdjustingBitrate: boolean = false;  // æ˜¯å¦æ­£åœ¨è°ƒæ•´ä¸­
  private bitrateDebounceTimer: number = -1;  // é˜²æŠ–å®šæ—¶å™¨
  
  // å…³é—­åŠ¨ç”»çŠ¶æ€
  private isClosing: boolean = false;
  
  // å¼¹çª—æ§åˆ¶å™¨
  private exitDialogController?: CustomDialogController;
  private touchModeDialogController?: CustomDialogController;
  private sleepDialogController?: CustomDialogController;
  private usbDriverDialogController?: CustomDialogController;
  
  aboutToAppear(): void {
    this.shortcuts = this.shortcutManager.getShortcuts();
    // åŠ è½½å½“å‰ç ç‡
    this.currentBitrate = this.viewModel.getCurrentBitrate();
    this.bitrateSliderValue = this.bitrateToSliderValue(this.currentBitrate);
    // ä¾æ¬¡å¼¹å‡ºåŠ¨ç”»ï¼ˆäº¤é”™å¯åŠ¨ï¼Œé—´éš”æ›´çŸ­ï¼‰
    this.animateInStaggered();
  }
  
  /**
   * äº¤é”™æ‰§è¡Œè¿›å…¥åŠ¨ç”»ï¼ˆæ¯ä¸ªæŒ‰é’®é—´éš” 50ms å¯åŠ¨ï¼Œè€Œä¸æ˜¯ç­‰å‰ä¸€ä¸ªå®Œæˆï¼‰
   */
  private animateInStaggered(): void {
    const staggerDelay = 50;  // æ¯ä¸ªæŒ‰é’®å¯åŠ¨é—´éš” 50ms
    
    for (let i = 0; i < 7; i++) {
      setTimeout(() => {
        animateTo({ 
          duration: 200,  // å•ä¸ªåŠ¨ç”»æ—¶é•¿
          curve: Curve.FastOutSlowIn,
        }, () => {
          this.setPos(i, 0);
        });
      }, i * staggerDelay);
    }
  }
  
  /**
   * é€’å½’æ‰§è¡Œè¿›å…¥åŠ¨ç”»ï¼ˆå¤‡ç”¨æ–¹æ¡ˆï¼‰
   */
  private animateInSequence(index: number): void {
    if (index >= 7) return;
    
    animateTo({ 
      duration: 280,  // ç¨å¿«çš„åŠ¨ç”»
      curve: Curve.FastOutSlowIn,  // æ›´æµç•…çš„æ›²çº¿
      onFinish: () => {
        // åŠ¨ç”»å®Œæˆåè§¦å‘ä¸‹ä¸€ä¸ª
        if (index < 6) {
          this.animateInSequence(index + 1);
        }
      }
    }, () => {
      this.setPos(index, 0);
    });
  }
  
  /**
   * æ‰§è¡Œå…³é—­åŠ¨ç”»å¹¶å…³é—­å¯¹è¯æ¡†
   */
  private animateOut(): void {
    // é˜²æ­¢é‡å¤è°ƒç”¨
    if (this.isClosing) {
      return;
    }
    this.isClosing = true;
    
    // ä¿å­˜å›è°ƒå¼•ç”¨ï¼Œé¿å…é—­åŒ…ä¸­ä¸Šä¸‹æ–‡ä¸¢å¤±
    const callbacks = this.callbacks;
    
    // åŒæ—¶æ‰§è¡Œæ‰€æœ‰æ»‘å‡ºåŠ¨ç”»ï¼ˆæ›´å¿«çš„é€€å‡ºï¼‰
    animateTo({ 
      duration: 200, 
      curve: Curve.FastOutLinearIn 
    }, () => {
      for (let i = 0; i < 7; i++) {
        this.setPos(i, 200);
      }
    });
    
    // åŠ¨ç”»å®Œæˆåå…³é—­å¯¹è¯æ¡†
    setTimeout(() => {
      // ä½¿ç”¨å¤–éƒ¨ä¼ å…¥çš„ onClose å›è°ƒå…³é—­å¯¹è¯æ¡†
      if (callbacks.onClose) {
        callbacks.onClose();
      }
      callbacks.onDismiss();
    }, 250);
  }
  
  private setPos(i: number, v: number): void {
    if (i === 0) this.pos0 = v;
    else if (i === 1) this.pos1 = v;
    else if (i === 2) this.pos2 = v;
    else if (i === 3) this.pos3 = v;
    else if (i === 4) this.pos4 = v;
    else if (i === 5) this.pos5 = v;
    else if (i === 6) this.pos6 = v;
  }
  
  private getPos(i: number): number {
    if (i === 0) return this.pos0;
    if (i === 1) return this.pos1;
    if (i === 2) return this.pos2;
    if (i === 3) return this.pos3;
    if (i === 4) return this.pos4;
    if (i === 5) return this.pos5;
    if (i === 6) return this.pos6;
    return 0;
  }
  
  private setScale(i: number, v: number): void {
    if (i === 0) this.scale0 = v;
    else if (i === 1) this.scale1 = v;
    else if (i === 2) this.scale2 = v;
    else if (i === 3) this.scale3 = v;
    else if (i === 4) this.scale4 = v;
    else if (i === 5) this.scale5 = v;
    else if (i === 6) this.scale6 = v;
  }
  
  private getScale(i: number): number {
    if (i === 0) return this.scale0;
    if (i === 1) return this.scale1;
    if (i === 2) return this.scale2;
    if (i === 3) return this.scale3;
    if (i === 4) return this.scale4;
    if (i === 5) return this.scale5;
    if (i === 6) return this.scale6;
    return 1;
  }
  
  private sendKeys(keys: number[]): void {
    this.viewModel.getSession()?.sendKeys(keys);
  }
  
  // ==================== ç ç‡è°ƒæ•´è¾…åŠ©æ–¹æ³• ====================
  
  /**
   * ç ç‡è½¬æ»‘å—å€¼ (500-200000 kbps -> 0-1995)
   */
  private bitrateToSliderValue(bitrate: number): number {
    return Math.max(0, Math.min(1995, Math.round((bitrate - 500) / 100)));
  }
  
  /**
   * æ»‘å—å€¼è½¬ç ç‡ (0-1995 -> 500-200000 kbps)
   */
  private sliderValueToBitrate(value: number): number {
    return (value * 100) + 500;
  }
  
  /**
   * æ ¼å¼åŒ–ç ç‡æ˜¾ç¤º
   */
  private formatBitrate(kbps: number): string {
    if (kbps >= 1000) {
      return `${(kbps / 1000).toFixed(0)} Mbps`;
    }
    return `${kbps} kbps`;
  }
  
  /**
   * åº”ç”¨ç ç‡è°ƒæ•´ï¼ˆå¸¦é˜²æŠ–ï¼‰
   */
  private applyBitrateChange(): void {
    if (this.bitrateDebounceTimer !== -1) {
      clearTimeout(this.bitrateDebounceTimer);
    }
    
    this.bitrateDebounceTimer = setTimeout(() => {
      const newBitrate = this.sliderValueToBitrate(this.bitrateSliderValue);
      this.isAdjustingBitrate = true;
      
      this.viewModel.setBitrate(newBitrate).then((success) => {
        this.isAdjustingBitrate = false;
        if (success) {
          this.currentBitrate = newBitrate;
          const message = `ç ç‡å·²è°ƒæ•´ä¸º ${this.formatBitrate(newBitrate)}`;
          console.info(message);
          promptAction.showToast({
            message: message,
            duration: 2000
          });
        } else {
          // æ¢å¤åŸæ¥çš„æ»‘å—ä½ç½®
          this.bitrateSliderValue = this.bitrateToSliderValue(this.currentBitrate);
          console.warn('ç ç‡è°ƒæ•´å¤±è´¥');
          promptAction.showToast({
            message: 'ç ç‡è°ƒæ•´å¤±è´¥',
            duration: 2000
          });
        }
      }).catch((err: Error) => {
        this.isAdjustingBitrate = false;
        this.bitrateSliderValue = this.bitrateToSliderValue(this.currentBitrate);
        console.error('ç ç‡è°ƒæ•´å¤±è´¥:', err);
        promptAction.showToast({
          message: 'ç ç‡è°ƒæ•´å¤±è´¥: ' + err.message,
          duration: 2000
        });
      });
      
      this.bitrateDebounceTimer = -1;
    }, 500);
  }
  
  /**
   * æ˜¾ç¤ºé€€å‡ºç¡®è®¤å¼¹çª—
   */
  private showExitDialog(): void {
    // ä¿å­˜å¼•ç”¨
    const callbacks = this.callbacks;
    
    const config: ActionDialogConfig = {
      title: 'ç¦»å¼€ä¸²æµ',
      actions: [
        {
          text: 'æ–­å¼€è¿æ¥',
          subtitle: 'æ¸¸æˆç»§ç»­åœ¨ä¸»æœºä¸Šè¿è¡Œ',
          color: '#3B82F6',
          backgroundColor: '#EFF6FF',
          onClick: () => {
            callbacks.onDisconnect();
            // ä½¿ç”¨å¤–éƒ¨ onClose å›è°ƒå…³é—­å¯¹è¯æ¡†
            if (callbacks.onClose) {
              callbacks.onClose();
            }
          }
        },
        {
          text: 'é€€å‡ºæ¸¸æˆ',
          subtitle: 'å…³é—­ä¸»æœºä¸Šçš„æ¸¸æˆ',
          color: '#EF4444',
          backgroundColor: '#FEF2F2',
          onClick: () => {
            callbacks.onQuitGame();
            // ä½¿ç”¨å¤–éƒ¨ onClose å›è°ƒå…³é—­å¯¹è¯æ¡†
            if (callbacks.onClose) {
              callbacks.onClose();
            }
          }
        }
      ],
      cancelText: 'ç»§ç»­æ¸¸æˆ',
      onCancel: () => {}
    };
    
    this.exitDialogController = new CustomDialogController({
      builder: ActionDialog({ config: config }),
      alignment: DialogAlignment.Center,
      customStyle: true,
      backgroundColor: Color.Transparent
    });
    this.exitDialogController.open();
  }
  
  /**
   * æ˜¾ç¤ºè§¦æ§æ¨¡å¼é€‰æ‹©å¼¹çª—
   */
  private showTouchModeDialog(): void {
    const currentMode = this.viewModel.touchMode;
    const config: ActionDialogConfig = {
      title: 'é€‰æ‹©è§¦æ‘¸æ¨¡å¼',
      actions: [
        {
          text: 'è§¦æ§æ¿',
          subtitle: currentMode === 'trackpad' ? 'âœ“ å½“å‰æ¨¡å¼' : 'åƒç¬”è®°æœ¬è§¦æ§æ¿ä¸€æ ·æ“ä½œ',
          color: currentMode === 'trackpad' ? '#10B981' : undefined,
          backgroundColor: currentMode === 'trackpad' ? '#D1FAE5' : undefined,
          onClick: () => {
            this.callbacks.onTouchModeChanged('trackpad');
          }
        },
        {
          text: 'å¤šç‚¹è§¦æ§',
          subtitle: currentMode === 'direct' ? 'âœ“ å½“å‰æ¨¡å¼' : 'ç›´æ¥ç‚¹å‡»å±å¹•ä½ç½®',
          color: currentMode === 'direct' ? '#10B981' : undefined,
          backgroundColor: currentMode === 'direct' ? '#D1FAE5' : undefined,
          onClick: () => {
            this.callbacks.onTouchModeChanged('direct');
          }
        },
        {
          text: 'é¼ æ ‡æ¨¡å¼',
          subtitle: currentMode === 'mouse' ? 'âœ“ å½“å‰æ¨¡å¼' : 'æ¨¡æ‹Ÿé¼ æ ‡ç§»åŠ¨å’Œç‚¹å‡»',
          color: currentMode === 'mouse' ? '#10B981' : undefined,
          backgroundColor: currentMode === 'mouse' ? '#D1FAE5' : undefined,
          onClick: () => {
            this.callbacks.onTouchModeChanged('mouse');
          }
        }
      ],
      cancelText: 'å–æ¶ˆ',
      onCancel: () => {}
    };
    
    this.touchModeDialogController = new CustomDialogController({
      builder: ActionDialog({ config: config }),
      alignment: DialogAlignment.Center,
      customStyle: true,
      backgroundColor: Color.Transparent
    });
    this.touchModeDialogController.open();
  }
  
  /**
   * æ˜¾ç¤ºä¼‘çœ ç¡®è®¤å¼¹çª—
   */
  private showSleepDialog(): void {
    const config: ConfirmDialogConfig = {
      title: 'ä¼‘çœ ä¸»æœº',
      message: 'è¿œç¨‹ä¸»æœºå°†è¿›å…¥ç¡çœ çŠ¶æ€ï¼Œéœ€è¦æ‰‹åŠ¨æˆ–é€šè¿‡ Wake-on-LAN å”¤é†’ã€‚',
      cancelButton: {
        text: 'å–æ¶ˆ',
        onClick: () => {}
      },
      confirmButton: {
        text: 'ä¼‘çœ ',
        color: '#6B7280',
        onClick: () => {
          // Win+X -> U -> S è§¦å‘ä¼‘çœ 
          this.sendKeys([VirtualKey.VK_LWIN, VirtualKey.VK_X]);
          setTimeout(() => {
            this.sendKeys([VirtualKey.VK_U]);
            setTimeout(() => { this.sendKeys([VirtualKey.VK_S]); }, 200);
          }, 200);
          this.animateOut();
        }
      }
    };
    
    this.sleepDialogController = new CustomDialogController({
      builder: ConfirmDialog({ config: config }),
      alignment: DialogAlignment.Center,
      customStyle: true,
      backgroundColor: Color.Transparent
    });
    this.sleepDialogController.open();
  }
  
  /**
   * æ˜¾ç¤º USB é©±åŠ¨æ¥ç®¡ç¡®è®¤å¼¹çª—
   */
  private showUsbDriverDialog(): void {
    const config: ConfirmDialogConfig = {
      title: 'å¼ºåˆ¶ USB é©±åŠ¨æ¥ç®¡',
      message: 'åˆ‡æ¢åˆ° USB é©±åŠ¨æ¨¡å¼åï¼Œå°†ç›´æ¥ä¸æ‰‹æŸ„é€šä¿¡ï¼Œè·å¾—æ›´ä½å»¶è¿Ÿå’Œæ›´å¤šåŠŸèƒ½ï¼ˆå¦‚éœ‡åŠ¨è°ƒèŠ‚ï¼‰ã€‚\n\nå½“å‰è¿æ¥çš„æ‰‹æŸ„ä¼šçŸ­æš‚æ–­å¼€å¹¶é‡æ–°è¿æ¥ã€‚\n\nå¦‚æœæ‰‹æŸ„å‡ºç°é—®é¢˜ï¼Œé‡å¯åº”ç”¨å¯æ¢å¤é»˜è®¤æ¨¡å¼ã€‚',
      cancelButton: {
        text: 'å–æ¶ˆ',
        onClick: () => {}
      },
      confirmButton: {
        text: 'æ¥ç®¡',
        color: '#3B82F6',
        onClick: () => {
          if (this.callbacks.onForceUsbDriver) {
            this.callbacks.onForceUsbDriver();
          }
          this.animateOut();
        }
      }
    };
    
    this.usbDriverDialogController = new CustomDialogController({
      builder: ConfirmDialog({ config: config }),
      alignment: DialogAlignment.Center,
      customStyle: true,
      backgroundColor: Color.Transparent
    });
    this.usbDriverDialogController.open();
  }
  
  private handleMenuClick(index: number): void {
    switch (index) {
      case 0: // Win
        this.sendKeys([VirtualKey.VK_LWIN]);
        this.animateOut();
        break;
      case 1: // USB é©±åŠ¨æ¥ç®¡
        this.showUsbDriverDialog();
        break;
      case 2: // HDR
        this.sendKeys([VirtualKey.VK_LWIN, VirtualKey.VK_MENU, VirtualKey.VK_B]);
        this.animateOut();
        break;
      case 3: // é”®ç›˜
        this.sendKeys([VirtualKey.VK_LWIN, VirtualKey.VK_CONTROL, VirtualKey.VK_O]);
        this.animateOut();
        break;
      case 4: // è§¦æ§
        this.showTouchModeDialog();
        break;
      case 5: // ä¼‘çœ 
        this.showSleepDialog();
        break;
      case 6: // é€€å‡º
        this.showExitDialog();
        break;
    }
  }
  
  build() {
    Stack({ alignContent: Alignment.Center }) {
      // ==================== èƒŒæ™¯å¯ç‚¹å‡»å…³é—­ ====================
      Column()
        .width('100%')
        .height('100%')
        .onClick(() => {
          if (this.expandedMenu === '') {
            this.animateOut();
          } else {
            this.expandedMenu = '';
          }
        })
      
      // ==================== ä¸€çº§èœå•ï¼ˆå³ä¾§è¢œå­æŒ‰é’®ï¼‰====================
      Column() {
        this.SockButton(0)
        this.SockButton(1)
        this.SockButton(2)
        this.SockButton(3)
        this.SockButton(4)
        this.SockButton(5)
        this.SockButton(6)
      }
      .alignItems(HorizontalAlign.End)
      .justifyContent(FlexAlign.Center)
      .padding({ top: 20, bottom: 20 })
      .position({ x: '100%', y: '50%' })
      .translate({ x: '-100%', y: '-50%' })
      
      // ==================== ä¸­å¤®é¢æ¿åŒºåŸŸ ====================
      Scroll() {
        Column({ space: 12 }) {
          // ç ç‡è°ƒæ•´å¡ç‰‡
          this.BitrateCard()
          
          // è¶…çº§æŒ‡ä»¤å¡ç‰‡ï¼ˆå•ç‹¬ï¼‰
          if (this.superCmds.length > 0) {
            this.SuperCmdCard()
          }
          
          // å¿«æ·é”®å¡ç‰‡ï¼ˆå•ç‹¬ï¼‰
          if (this.shortcuts.length > 0) {
            this.ShortcutCard()
          }
        }
        .alignItems(HorizontalAlign.Center)
        .justifyContent(FlexAlign.Start)
        .padding({ top: 20, bottom: 20 })
      }
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Off)
      .constraintSize({ maxHeight: '80%' })
      .position({ x: '50%', y: '50%' })
      .translate({ x: '-50%', y: '-50%' })
      
      // ==================== äºŒçº§èœå•é®ç½© ====================
      if (this.expandedMenu !== '') {
        Column()
          .width('100%')
          .height('100%')
          .backgroundColor('#00000099')
          .onClick(() => { this.expandedMenu = ''; })
          .transition({ type: TransitionType.Insert, opacity: 0 })
          .transition({ type: TransitionType.Delete, opacity: 0 })
      }
    }
    .width('100%')
    .height('100%')
  }
  
  /**
   * ç ç‡è°ƒæ•´å¡ç‰‡ - å¥¶æ²¹é£æ ¼
   */
  @Builder
  BitrateCard() {
    Column() {
      // æ ‡é¢˜æ 
      Row() {
        Text('ğŸ“Š')
          .fontSize(13)
        Text(' ç ç‡è°ƒæ•´')
          .fontSize(13)
          .fontWeight(FontWeight.Medium)
          .fontColor('#E0FFFFFF')
        Blank()
        Text(this.formatBitrate(this.currentBitrate))
          .fontSize(12)
          .fontColor('#FFB7C5')  // æ¨±èŠ±ç²‰
          .fontWeight(FontWeight.Medium)
      }
      .width('100%')
      .padding({ left: 16, right: 16, top: 14, bottom: 4 })
      
      // æç¤ºè¯´æ˜
      Text('å®æ—¶è°ƒæ•´ä¸²æµç”»è´¨ï¼Œéœ€ Foundation Sunshine æ”¯æŒ')
        .fontSize(10)
        .fontColor('#60FFFFFF')
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 8 })
      
      // æ»‘å—
      Column() {
        Slider({
          value: this.bitrateSliderValue,
          min: 0,
          max: 1995,
          step: 1,
          style: SliderStyle.OutSet
        })
          .width('100%')
          .blockColor('#FFB7C5')
          .trackColor('#30FFFFFF')
          .selectedColor('#FFB7C5')
          .showSteps(false)
          .showTips(false)
          .onChange((value: number, mode: SliderChangeMode) => {
            this.bitrateSliderValue = value;
            if (mode === SliderChangeMode.End || mode === SliderChangeMode.Click) {
              this.applyBitrateChange();
            }
          })
        
        // èŒƒå›´æ ‡ç­¾
        Row() {
          Text('0.5')
            .fontSize(10)
            .fontColor('#80FFFFFF')
          Blank()
          Text(this.isAdjustingBitrate ? 'è°ƒæ•´ä¸­...' : this.formatBitrate(this.sliderValueToBitrate(this.bitrateSliderValue)))
            .fontSize(11)
            .fontColor(this.isAdjustingBitrate ? '#80FFFFFF' : '#FFB7C5')
            .fontWeight(FontWeight.Bold)
          Blank()
          Text('200')
            .fontSize(10)
            .fontColor('#80FFFFFF')
        }
        .width('100%')
      }
      .width('100%')
      .padding({ left: 14, right: 14, bottom: 12 })
    }
    .width(280)
    .backgroundColor('#25FFFFFF')  // åŠé€æ˜ç™½è‰²
    .backdropBlur(40)  // æ¯›ç»ç’ƒæ•ˆæœ
    .borderRadius(20)
    .border({ width: 1, color: '#20FFFFFF' })
    .shadow({ radius: 20, color: '#20000000', offsetY: 4 })
  }
  
  /**
   * è¶…çº§æŒ‡ä»¤å¡ç‰‡ - å¥¶æ²¹é£æ ¼ï¼ˆç‹¬ç«‹å¡ç‰‡ï¼‰
   */
  @Builder
  SuperCmdCard() {
    Column() {
      Row() {
        Text('ğŸ¯')
          .fontSize(13)
        Text(' æœåŠ¡ç«¯æŒ‡ä»¤')
          .fontSize(13)
          .fontWeight(FontWeight.Medium)
          .fontColor('#E0FFFFFF')
      }
      .width('100%')
      .padding({ left: 16, right: 12, top: 14, bottom: 4 })
      
      // æç¤ºè¯´æ˜
      Text('æ‰§è¡Œ Sunshine é¢„è®¾è„šæœ¬')
        .fontSize(10)
        .fontColor('#60FFFFFF')
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 6 })
      
      Scroll() {
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Center }) {
          ForEach(this.superCmds, (cmd: SuperCmd) => {
            this.SuperCmdPill(cmd)
          })
        }
        .width('100%')
      }
      .width('100%')
      .constraintSize({ maxHeight: 100 })
      .scrollBar(BarState.Off)
      .padding({ left: 14, right: 14, top: 10, bottom: 14 })
    }
    .width(280)
    .backgroundColor('#25FFFFFF')
    .backdropBlur(40)
    .borderRadius(20)
    .border({ width: 1, color: '#20FFFFFF' })
    .shadow({ radius: 20, color: '#20000000', offsetY: 4 })
  }
  
  /**
   * å¿«æ·é”®å¡ç‰‡ - å¥¶æ²¹é£æ ¼ï¼ˆç‹¬ç«‹å¡ç‰‡ï¼‰
   */
  @Builder
  ShortcutCard() {
    Column() {
      Row() {
        Text('âš¡')
          .fontSize(13)
        Text(' å¿«æ·é”®')
          .fontSize(13)
          .fontWeight(FontWeight.Medium)
          .fontColor('#E0FFFFFF')
        Blank()
        Text('ï¼‹')
          .fontSize(14)
          .fontColor('#FFFFFF')
          .fontWeight(FontWeight.Bold)
          .width(24)
          .height(24)
          .textAlign(TextAlign.Center)
          .borderRadius(12)
          .backgroundColor('#40A8E8B0')  // è–„è·ç»¿åŠé€æ˜
          .onClick(() => {
            if (this.callbacks.onOpenShortcutEditor) {
              this.callbacks.onOpenShortcutEditor();
            }
          })
      }
      .width('100%')
      .padding({ left: 16, right: 12, top: 14 })
      
      Scroll() {
        Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Center }) {
          ForEach(this.shortcuts, (shortcut: Shortcut) => {
            this.ShortcutPill(shortcut)
          })
        }
        .width('100%')
      }
      .width('100%')
      .constraintSize({ maxHeight: 120 })
      .scrollBar(BarState.Off)
      .padding({ left: 14, right: 14, top: 10, bottom: 14 })
    }
    .width(280)
    .backgroundColor('#25FFFFFF')
    .backdropBlur(40)
    .borderRadius(20)
    .border({ width: 1, color: '#20FFFFFF' })
    .shadow({ radius: 20, color: '#20000000', offsetY: 4 })
  }
  
  /**
   * å¿«æ·é”®/è¶…çº§æŒ‡ä»¤é¢æ¿ - å¥¶æ²¹é£æ ¼ï¼ˆä¿ç•™ç”¨äºå…¼å®¹ï¼Œä½†ä¸å†ä½¿ç”¨ï¼‰
   */
  @Builder
  ShortcutPanel() {
    Column() {
      // è¶…çº§æŒ‡ä»¤åŒºåŸŸ (Sunshine åŠŸèƒ½)
      if (this.superCmds.length > 0) {
        Row() {
          Text('ğŸ¯')
            .fontSize(13)
          Text(' æœåŠ¡ç«¯æŒ‡ä»¤')
            .fontSize(13)
            .fontWeight(FontWeight.Medium)
            .fontColor('#E0FFFFFF')
        }
        .width('100%')
        .padding({ left: 16, right: 12, top: 14 })
        
        Scroll() {
          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Center }) {
            ForEach(this.superCmds, (cmd: SuperCmd) => {
              this.SuperCmdPill(cmd)
            })
          }
          .width('100%')
        }
        .width('100%')
        .constraintSize({ maxHeight: 80 })
        .scrollBar(BarState.Off)
        .padding({ left: 14, right: 14, top: 10, bottom: this.shortcuts.length > 0 ? 8 : 14 })
      }
      
      // åˆ†å‰²çº¿
      if (this.superCmds.length > 0 && this.shortcuts.length > 0) {
        Row()
          .width('85%')
          .height(1)
          .backgroundColor('#15FFFFFF')
      }
      
      // å¿«æ·é”®åŒºåŸŸ
      if (this.shortcuts.length > 0) {
        Row() {
          Text('âš¡')
            .fontSize(13)
          Text(' å¿«æ·é”®')
            .fontSize(13)
            .fontWeight(FontWeight.Medium)
            .fontColor('#E0FFFFFF')
          Blank()
          Text('ï¼‹')
            .fontSize(14)
            .fontColor('#FFFFFF')
            .fontWeight(FontWeight.Bold)
            .width(24)
            .height(24)
            .textAlign(TextAlign.Center)
            .borderRadius(12)
            .backgroundColor('#40A8E8B0')  // è–„è·ç»¿åŠé€æ˜
            .onClick(() => {
              if (this.callbacks.onOpenShortcutEditor) {
                this.callbacks.onOpenShortcutEditor();
              }
            })
        }
        .width('100%')
        .padding({ left: 16, right: 12, top: this.superCmds.length > 0 ? 8 : 14 })
        
        Scroll() {
          Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Center }) {
            ForEach(this.shortcuts, (shortcut: Shortcut) => {
              this.ShortcutPill(shortcut)
            })
          }
          .width('100%')
        }
        .width('100%')
        .constraintSize({ maxHeight: 100 })
        .scrollBar(BarState.Off)
        .padding({ left: 14, right: 14, top: 10, bottom: 14 })
      }
    }
    .width(280)
    .backgroundColor('#25FFFFFF')  // åŠé€æ˜ç™½è‰²
    .backdropBlur(40)  // æ¯›ç»ç’ƒæ•ˆæœ
    .borderRadius(20)
    .border({ width: 1, color: '#20FFFFFF' })
    .shadow({ radius: 20, color: '#20000000', offsetY: 4 })
  }
  
  // ==================== å­ç»„ä»¶ ====================
  
  /**
   * é•¿ç­’è¢œæŒ‰é’®
   */
  @Builder
  SockButton(index: number) {
    Row() {
      // è¢œå¤´ï¼ˆæ·±è‰²åœ†å¤´ï¼‰
      Column()
        .width(22)
        .height(36)
        .backgroundColor(this.menuItems[index].borderColor)
        .borderRadius({ topLeft: 18, bottomLeft: 18 })
      
      // è¢œç­’ï¼ˆæµ…è‰²ä¸»ä½“ï¼‰
      Row() {
        Text(this.menuItems[index].label)
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor(this.menuItems[index].borderColor)  // ä½¿ç”¨è¾¹æ¡†è‰²ä½œä¸ºæ–‡å­—è‰²
      }
      .width(75)
      .height(36)
      .justifyContent(FlexAlign.Center)
      .alignItems(VerticalAlign.Center)
      .backgroundColor(this.menuItems[index].bgColor)
      
      // è•¾ä¸è¾¹ï¼ˆæ³¢æµªè£…é¥°ï¼‰
      Column() {
        Row()
          .width(10)
          .height(5)
          .backgroundColor(this.menuItems[index].borderColor)
          .borderRadius({ topLeft: 5, topRight: 5 })
        Row()
          .width(10)
          .height(5)
          .backgroundColor(this.menuItems[index].borderColor)
          .borderRadius({ bottomLeft: 5, bottomRight: 5 })
          .margin({ top: 2 })
        Row()
          .width(10)
          .height(5)
          .backgroundColor(this.menuItems[index].borderColor)
          .borderRadius({ topLeft: 5, topRight: 5 })
          .margin({ top: 2 })
        Row()
          .width(10)
          .height(5)
          .backgroundColor(this.menuItems[index].borderColor)
          .borderRadius({ bottomLeft: 5, bottomRight: 5 })
          .margin({ top: 2 })
        Row()
          .width(10)
          .height(5)
          .backgroundColor(this.menuItems[index].borderColor)
          .borderRadius({ topLeft: 5, topRight: 5 })
          .margin({ top: 2 })
      }
      .height(36)
      .justifyContent(FlexAlign.Center)
      .backgroundColor(this.menuItems[index].bgColor)
    }
    .height(40)
    .padding(2)
    .scale({ x: this.getScale(index), y: this.getScale(index) })
    .translate({ x: this.getPos(index) })  // ä½¿ç”¨ translateX æ§åˆ¶æ°´å¹³æ»‘åŠ¨
    .margin({ right: this.offsets[index], bottom: 4 })  // offsets ç”¨äºä¸è§„åˆ™æ’åˆ—
    .onClick(() => this.handleMenuClick(index))
  }
  
  /**
   * å¿«æ·é”®è¯ä¸¸ - å¥¶æ²¹é£æ ¼
   */
  @Builder
  ShortcutPill(shortcut: Shortcut) {
    Row() {
      if (shortcut.icon) {
        Text(shortcut.icon)
          .fontSize(11)
          .margin({ right: 4 })
      }
      Text(shortcut.name)
        .fontSize(11)
        .fontColor('#F0FFFFFF')
    }
    .padding({ left: 12, right: 12, top: 6, bottom: 6 })
    .backgroundColor(`#50${(shortcut.color || '#9DABB2').replace('#', '')}`)
    .border({ width: 1, color: `#80${(shortcut.color || '#9DABB2').replace('#', '')}` })
    .borderRadius(14)
    .margin({ right: 6, bottom: 6 })
    .onClick(() => {
      this.sendKeys(shortcut.keys);
      this.animateOut();
    })
    .gesture(
      LongPressGesture({ duration: 500 })
        .onAction(() => {
          // é•¿æŒ‰æ˜¾ç¤ºç¼–è¾‘/åˆ é™¤èœå•ï¼ˆä»…ç”¨æˆ·è‡ªå®šä¹‰å¿«æ·é”®ï¼‰
          if (!shortcut.isBuiltin) {
            this.showShortcutOptions(shortcut);
          }
        })
    )
  }
  
  /**
   * æ˜¾ç¤ºå¿«æ·é”®ç¼–è¾‘/åˆ é™¤é€‰é¡¹
   */
  private showShortcutOptions(shortcut: Shortcut): void {
    promptAction.showDialog({
      title: shortcut.name,
      message: 'é€‰æ‹©æ“ä½œ',
      buttons: [
        { text: 'ç¼–è¾‘', color: '#10B981' },
        { text: 'åˆ é™¤', color: '#EF4444' },
        { text: 'å–æ¶ˆ', color: '#6B7280' }
      ]
    }).then((result) => {
      if (result.index === 0) {
        // ç¼–è¾‘
        if (this.callbacks.onEditShortcut) {
          this.callbacks.onEditShortcut(shortcut);
        }
      } else if (result.index === 1) {
        // åˆ é™¤
        this.confirmDeleteShortcut(shortcut);
      }
    });
  }
  
  /**
   * ç¡®è®¤åˆ é™¤å¿«æ·é”®
   */
  private confirmDeleteShortcut(shortcut: Shortcut): void {
    promptAction.showDialog({
      title: 'åˆ é™¤å¿«æ·é”®',
      message: `ç¡®å®šè¦åˆ é™¤å¿«æ·é”®"${shortcut.name}"å—ï¼Ÿ`,
      buttons: [
        { text: 'åˆ é™¤', color: '#EF4444' },
        { text: 'å–æ¶ˆ', color: '#6B7280' }
      ]
    }).then((result) => {
      if (result.index === 0) {
        if (this.callbacks.onDeleteShortcut) {
          this.callbacks.onDeleteShortcut(shortcut);
        }
      }
    });
  }
  
  /**
   * è¶…çº§æŒ‡ä»¤è¯ä¸¸ - å¥¶æ²¹é£æ ¼ (Sunshine åŠŸèƒ½)
   */
  @Builder
  SuperCmdPill(cmd: SuperCmd) {
    Row() {
      // ç”¨é¦–å­—ä½œä¸ºå›¾æ ‡
      Text(cmd.name.length > 0 ? cmd.name.charAt(0) : '?')
        .fontSize(11)
        .fontWeight(FontWeight.Bold)
        .fontColor('#FFFFFF')
        .width(20)
        .height(20)
        .textAlign(TextAlign.Center)
        .backgroundColor('#60A5FA')  // å¤©è“è‰²
        .borderRadius(10)
        .margin({ right: 6 })
      Text(cmd.name)
        .fontSize(11)
        .fontColor('#F0FFFFFF')
    }
    .padding({ left: 6, right: 12, top: 6, bottom: 6 })
    .backgroundColor('#20FFFFFF')  // åŠé€æ˜ç™½è‰²
    .border({ width: 1, color: '#30FFFFFF' })
    .borderRadius(16)
    .margin({ right: 6, bottom: 6 })
    .onClick(() => {
      if (this.callbacks.onSendSuperCmd) {
        this.callbacks.onSendSuperCmd(cmd.id);
      }
      this.animateOut();
    })
  }
}
