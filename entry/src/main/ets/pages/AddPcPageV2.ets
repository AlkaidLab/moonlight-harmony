/*
 * Moonlight for HarmonyOS
 * Copyright (C) 2024-2025 Moonlight/AlkaidLab
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 */

import { router, promptAction } from '@kit.ArkUI';
import { ComputerManager } from '../service/ComputerManager';
import { AppColors, AppSizes, AppSpacing, AppAnimation, AppShadows } from '../common/Theme';
import { common } from '@kit.AbilityKit';

/**
 * åœ°å€è§£æç»“æœ
 */
class AddressPortResult {
  address: string = '';
  port: number | undefined = undefined;
}

/**
 * æ·»åŠ ç”µè„‘é¡µé¢ (ç°ä»£åŒ–ç‰ˆæœ¬)
 */
@Entry
@Component
struct AddPcPageV2 {
  @State ipAddress: string = '';
  @State isAdding: boolean = false;
  @State errorMessage: string = '';
  @State isValidInput: boolean = false;
  @State showSuccess: boolean = false;
  
  private computerManager: ComputerManager = ComputerManager.getInstance();

  build() {
    Column() {
      // æ ‡é¢˜æ 
      this.TitleBar()
      
      // ä¸»å†…å®¹
      Scroll() {
        Column() {
          // è¯´æ˜å¡ç‰‡
          this.InstructionCard()
          
          // è¾“å…¥åŒºåŸŸ
          this.InputSection()
          
          // é”™è¯¯æç¤º
          if (this.errorMessage) {
            this.ErrorMessage()
          }
          
          // æ·»åŠ æŒ‰é’®
          this.AddButton()
          
          // æç¤ºä¿¡æ¯
          this.HelpInfo()
        }
        .width('100%')
        .padding({ left: AppSpacing.Large, right: AppSpacing.Large })
      }
      .layoutWeight(1)
      .scrollBar(BarState.Off)
    }
    .width('100%')
    .height('100%')
    .backgroundColor(AppColors.Background)
  }

  @Builder
  TitleBar() {
    Row() {
      // è¿”å›æŒ‰é’® - éœ“è™¹é£æ ¼
      Button({ type: ButtonType.Circle }) {
        Image($r('app.media.ic_back'))
          .width(AppSizes.IconMedium)
          .height(AppSizes.IconMedium)
          .fillColor(AppColors.Primary)
      }
      .width(40)
      .height(40)
      .backgroundColor(AppColors.Surface)
      .borderWidth(1)
      .borderColor(AppColors.CardBorder)
      .onClick(() => router.back())

      Column() {
        Text('æ·»åŠ ç”µè„‘')
          .fontSize(AppSizes.FontTitle)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppColors.Primary)
        Text('æ‰‹åŠ¨è¾“å…¥ IP åœ°å€')
          .fontSize(AppSizes.FontCaption)
          .fontColor(AppColors.TextSecondary)
          .margin({ top: 2 })
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: AppSpacing.Medium })

      Blank()
    }
    .width('100%')
    .padding({
      left: AppSpacing.Large,
      right: AppSpacing.Large,
      top: 56,
      bottom: AppSpacing.Large
    })
  }

  @Builder
  InstructionCard() {
    Column() {
      Row() {
        // å›¾æ ‡ - éœ“è™¹å‘å…‰
        Column() {
          Text('ğŸŒ')
            .fontSize(24)
        }
        .width(48)
        .height(48)
        .borderRadius(14)
        .backgroundColor(AppColors.Surface)
        .borderWidth(2)
        .borderColor(AppColors.Accent)
        .justifyContent(FlexAlign.Center)
        .shadow(AppShadows.GlowCyan)

        Column() {
          Text('è¿æ¥åˆ°ä¸»æœº')
            .fontSize(AppSizes.FontSubtitle)
            .fontWeight(FontWeight.Bold)
            .fontColor(AppColors.Accent)

          Text('è¾“å…¥è¿è¡Œ Sunshine æˆ– GeForce Experience çš„ç”µè„‘ IP åœ°å€')
            .fontSize(AppSizes.FontCaption)
            .fontColor(AppColors.TextSecondary)
            .margin({ top: 4 })
        }
        .alignItems(HorizontalAlign.Start)
        .margin({ left: AppSpacing.Medium })
        .layoutWeight(1)
      }
      .width('100%')
    }
    .width('100%')
    .padding(AppSpacing.Large)
    .backgroundColor(AppColors.CardBackground)
    .borderRadius(AppSizes.RadiusLarge)
    .borderWidth(1)
    .borderColor(AppColors.CardBorder)
    .margin({ top: AppSpacing.Large })
  }

  @Builder
  InputSection() {
    Column() {
      Text('IP åœ°å€æˆ–ä¸»æœºå')
        .fontSize(AppSizes.FontCaption)
        .fontColor(AppColors.Primary)
        .fontWeight(FontWeight.Medium)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: AppSpacing.Small })

      Row() {
        Image($r('app.media.ic_computer'))
          .width(20)
          .height(20)
          .fillColor(this.ipAddress ? AppColors.Primary : AppColors.TextTertiary)
          .margin({ right: AppSpacing.Medium })

        TextInput({ placeholder: 'ä¾‹å¦‚: 192.168.1.100 æˆ– 192.168.1.100:47989', text: this.ipAddress })
          .layoutWeight(1)
          .height(48)
          .fontSize(AppSizes.FontBody)
          .fontColor(AppColors.TextPrimary)
          .caretColor(AppColors.Primary)
          .placeholderColor(AppColors.TextTertiary)
          .backgroundColor(Color.Transparent)
          .onChange((value: string) => {
            this.ipAddress = value;
            this.validateInput();
            this.errorMessage = '';
          })
          .onSubmit(() => {
            if (this.isValidInput) {
              this.addComputer();
            }
          })

        if (this.ipAddress.length > 0) {
          Button({ type: ButtonType.Circle }) {
            Image($r('app.media.ic_error'))
              .width(16)
              .height(16)
              .fillColor(AppColors.TextSecondary)
          }
          .width(28)
          .height(28)
          .backgroundColor(AppColors.Surface)
          .onClick(() => {
            this.ipAddress = '';
            this.isValidInput = false;
            this.errorMessage = '';
          })
        }
      }
      .width('100%')
      .height(56)
      .padding({ left: AppSpacing.Medium, right: AppSpacing.Small })
      .backgroundColor(AppColors.Surface)
      .borderRadius(AppSizes.RadiusLarge)
      .border({
        width: 1.5,
        color: this.errorMessage ? AppColors.Error :
               (this.ipAddress ? AppColors.Primary : AppColors.CardBorder)
      })
    }
    .width('100%')
    .margin({ top: AppSpacing.XLarge })
  }

  @Builder
  ErrorMessage() {
    Row() {
      Image($r('app.media.ic_error'))
        .width(16)
        .height(16)
        .fillColor(AppColors.Error)
        .margin({ right: AppSpacing.Small })

      Text(this.errorMessage)
        .fontSize(AppSizes.FontCaption)
        .fontColor(AppColors.Error)
    }
    .width('100%')
    .padding({ left: AppSpacing.Small, right: AppSpacing.Small, top: AppSpacing.Small, bottom: AppSpacing.Small })
    .backgroundColor(AppColors.Error + '15')
    .borderRadius(AppSizes.RadiusMedium)
    .margin({ top: AppSpacing.Small })
    .transition(TransitionEffect.OPACITY.animation({ duration: AppAnimation.Fast }))
  }

  @Builder
  AddButton() {
    Button({ type: ButtonType.Normal }) {
      Row() {
        if (this.isAdding) {
          LoadingProgress()
            .width(20)
            .height(20)
            .color(AppColors.TextOnPrimary)
            .margin({ right: AppSpacing.Small })
        }
        Text(this.isAdding ? 'æ­£åœ¨è¿æ¥...' : 'æ·»åŠ ç”µè„‘')
          .fontSize(AppSizes.FontSubtitle)
          .fontWeight(FontWeight.Medium)
          .fontColor(AppColors.TextOnPrimary)
      }
    }
    .width('100%')
    .height(52)
    .borderRadius(AppSizes.RadiusLarge)
    .backgroundColor(this.isValidInput && !this.isAdding ? AppColors.Primary : AppColors.TextTertiary)
    .shadow(this.isValidInput && !this.isAdding ? AppShadows.GlowGreen : AppShadows.Small)
    .enabled(this.isValidInput && !this.isAdding)
    .margin({ top: AppSpacing.XLarge })
    .onClick(() => this.addComputer())
  }

  @Builder
  HelpInfo() {
    Column() {
      Text('æç¤º')
        .fontSize(AppSizes.FontCaption)
        .fontWeight(FontWeight.Medium)
        .fontColor(AppColors.TextSecondary)
        .alignSelf(ItemAlign.Start)
        .margin({ bottom: AppSpacing.Medium })
      
      this.HelpItem('ç¡®ä¿ç”µè„‘å’Œæ‰‹æœºåœ¨åŒä¸€ç½‘ç»œ')
      this.HelpItem('ç¡®ä¿ Sunshine æˆ– GFE æ­£åœ¨è¿è¡Œ')
      this.HelpItem('æ£€æŸ¥é˜²ç«å¢™æ˜¯å¦å…è®¸è¿æ¥')
      this.HelpItem('æ”¯æŒ IPv4 å’Œ IPv6 åœ°å€')
      this.HelpItem('æ”¯æŒè‡ªå®šä¹‰ç«¯å£ï¼Œå¦‚ 192.168.1.100:47989')
      this.HelpItem('IPv6 è‡ªå®šä¹‰ç«¯å£æ ¼å¼: [::1]:47989')
    }
    .width('100%')
    .padding(AppSpacing.Large)
    .backgroundColor(AppColors.Surface)
    .borderRadius(AppSizes.RadiusLarge)
    .margin({ top: AppSpacing.XXLarge })
  }

  @Builder
  HelpItem(text: string) {
    Row() {
      Circle()
        .width(6)
        .height(6)
        .fill(AppColors.TextTertiary)
        .margin({ right: AppSpacing.Medium })
      
      Text(text)
        .fontSize(AppSizes.FontCaption)
        .fontColor(AppColors.TextSecondary)
    }
    .width('100%')
    .margin({ bottom: AppSpacing.Small })
  }

  private validateInput(): void {
    const value = this.ipAddress.trim();
    
    if (!value) {
      this.isValidInput = false;
      return;
    }
    
    // åˆ†ç¦»åœ°å€å’Œç«¯å£
    const parseResult = this.parseAddressAndPort(value);
    if (!parseResult) {
      this.isValidInput = false;
      return;
    }
    
    const address = parseResult.address;
    const port = parseResult.port;
    
    // éªŒè¯ç«¯å£ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
    if (port !== undefined && (port <= 0 || port > 65535)) {
      this.isValidInput = false;
      return;
    }
    
    // IPv4 æ ¼å¼
    const ipv4Regex = /^(\d{1,3}\.){3}\d{1,3}$/;
    if (ipv4Regex.test(address)) {
      const parts = address.split('.');
      this.isValidInput = parts.every(part => {
        const num = parseInt(part);
        return num >= 0 && num <= 255;
      });
      return;
    }
    
    // IPv6 æ ¼å¼ (ç®€åŒ–æ£€æµ‹)
    if (address.includes(':')) {
      this.isValidInput = true;
      return;
    }
    
    // ä¸»æœºåæ ¼å¼
    const hostnameRegex = /^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?)*$/;
    this.isValidInput = hostnameRegex.test(address);
  }

  /**
   * è§£æåœ°å€å’Œç«¯å£
   * æ”¯æŒæ ¼å¼ï¼š
   *   - "192.168.1.100" -> { address: "192.168.1.100" }
   *   - "192.168.1.100:47989" -> { address: "192.168.1.100", port: 47989 }
   *   - "[::1]" -> { address: "::1" }
   *   - "[::1]:47989" -> { address: "::1", port: 47989 }
   *   - "::1" -> { address: "::1" }
   */
  private parseAddressAndPort(input: string): AddressPortResult | null {
    // æ£€æŸ¥æ˜¯å¦ä¸º IPv6 åœ°å€ï¼ˆåŒ…å«å¤šä¸ªå†’å·ï¼‰
    let colonCount = 0;
    for (let i = 0; i < input.length; i++) {
      if (input.charAt(i) === ':') {
        colonCount++;
      }
    }
    const isLikelyIPv6 = colonCount >= 2;
    const result = new AddressPortResult();
    
    if (isLikelyIPv6) {
      if (input.startsWith('[')) {
        // æ ¼å¼: [::1] æˆ– [::1]:47989
        const closeBracket = input.indexOf(']');
        if (closeBracket > 0) {
          result.address = input.substring(1, closeBracket);
          if (closeBracket < input.length - 1 && input.charAt(closeBracket + 1) === ':') {
            const portStr = input.substring(closeBracket + 2);
            const port = parseInt(portStr);
            if (!isNaN(port)) {
              result.port = port;
              return result;
            }
            return null; // æ— æ•ˆç«¯å£
          }
          return result;
        }
        return null; // æ— æ•ˆæ ¼å¼
      } else {
        // çº¯ IPv6 åœ°å€ï¼Œä¸å°è¯•è§£æç«¯å£ï¼ˆå¤ªå¤æ‚ï¼‰
        result.address = input;
        return result;
      }
    } else {
      // IPv4 æˆ–ä¸»æœºå
      const colonIndex = input.indexOf(':');
      if (colonIndex > 0) {
        // æ ¼å¼: 192.168.1.100:47989
        result.address = input.substring(0, colonIndex);
        const portStr = input.substring(colonIndex + 1);
        const port = parseInt(portStr);
        if (!isNaN(port)) {
          result.port = port;
          return result;
        }
        return null; // æ— æ•ˆç«¯å£
      }
      result.address = input;
      return result;
    }
  }

  private async addComputer(): Promise<void> {
    if (!this.isValidInput || this.isAdding) {
      return;
    }
    
    this.isAdding = true;
    this.errorMessage = '';
    
    try {
      const result = await this.computerManager.addComputer(this.ipAddress.trim());
      
      if (result) {
        // æˆåŠŸåŠ¨ç”»
        animateTo({ duration: AppAnimation.Normal }, () => {
          this.showSuccess = true;
        });
        
        promptAction.showToast({ message: 'æ·»åŠ æˆåŠŸ' });
        
        // å»¶è¿Ÿè¿”å›
        setTimeout(() => {
          router.back();
        }, 500);
      } else {
        this.errorMessage = 'æ— æ³•è¿æ¥åˆ°ä¸»æœºï¼Œè¯·æ£€æŸ¥åœ°å€æ˜¯å¦æ­£ç¡®';
      }
    } catch (err) {
      this.errorMessage = (err as Error).message || 'è¿æ¥å¤±è´¥';
    } finally {
      this.isAdding = false;
    }
  }
}
