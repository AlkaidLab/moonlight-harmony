/*
 * Moonlight for HarmonyOS
 * Copyright (C) 2024-2025 Moonlight/AlkaidLab
 *
 * This program is free software: you can redistribute it and/or modify
 * it under the terms of the GNU General Public License as published by
 * the Free Software Foundation, either version 3 of the License, or
 * (at your option) any later version.
 */

import { router, promptAction } from '@kit.ArkUI';
import { display } from '@kit.ArkUI';
import { ComputerManager } from '../service/ComputerManager';
import { NvHttp, AppEntry, DisplayInfo } from '../service/NvHttp';
import { AppCard } from '../components/AppCard';
import { AppListViewModel, ObservableApp } from '../viewmodel/AppViewModel';
import { AppColors, AppSizes, AppSpacing, AppAnimation, AppShadows } from '../common/Theme';
import { common } from '@kit.AbilityKit';
import { PairState } from '../model/ComputerInfo';
import { OptionPickerDialog, OptionPickerDialogConfig, OptionItem } from '../components/OptionPickerDialog';
import { ConfirmDialog, ConfirmDialogConfig } from '../components/ConfirmDialog';

interface AppListPageParams {
  computerId: string;
}

/**
 * åº”ç”¨åˆ—è¡¨é¡µé¢ (ç°ä»£åŒ–ç‰ˆæœ¬)
 */
// ç«–å±æ—¶ï¼Œappæ•°é‡å°äºç­‰äºæ­¤é˜ˆå€¼æ—¶ä½¿ç”¨1è¡Œ
const VERTICAL_SINGLE_ROW_THRESHOLD = 5;
// é»˜è®¤è¡Œæ•°
const DEFAULT_VERTICAL_ROW_COUNT = 2;
const DEFAULT_HORIZONTAL_ROW_COUNT = 1;

@Entry
@Component
struct AppListPageV2 {
  @State viewModel: AppListViewModel = new AppListViewModel();
  @State computerName: string = '';
  @State isLoading: boolean = true;
  @State isRefreshing: boolean = false;
  @State searchText: string = '';
  @State showSearch: boolean = false;
  @State gridColumns: number = 3;
  @State backgroundImageUrl: string = '';
  @State backgroundOpacity: number = 0; // èƒŒæ™¯é€æ˜åº¦ï¼ˆç”¨äºæ·¡å…¥åŠ¨ç”»ï¼‰
  @State rowCount: number = DEFAULT_HORIZONTAL_ROW_COUNT;
  @State isLandscape: boolean = true;
  // æ˜¾ç¤ºå™¨é€‰æ‹©ç›¸å…³
  @State availableDisplays: DisplayInfo[] = [];
  @State selectedDisplayIndex: number = -1; // -1 è¡¨ç¤ºä½¿ç”¨é»˜è®¤æ˜¾ç¤ºå™¨
  @State useVirtualDisplay: boolean = false; // æ˜¯å¦ä½¿ç”¨è™šæ‹Ÿæ˜¾ç¤ºå™¨
  @State supportsDisplayApi: boolean = false; // æœåŠ¡å™¨æ˜¯å¦æ”¯æŒ displays API
  
  private computerId: string = '';
  private computerManager: ComputerManager = ComputerManager.getInstance();
  private nvHttp: NvHttp | null = null;
  private searchDebounceTimer: number = -1; // æœç´¢é˜²æŠ–å®šæ—¶å™¨
  private iconPollIntervalId: number = -1; // å›¾æ ‡è½®è¯¢å®šæ—¶å™¨ID
  
  // CustomDialogController é…ç½®
  private optionPickerDialogConfig: OptionPickerDialogConfig = {
    title: '',
    options: [],
    onSelect: () => {}
  };
  private confirmDialogConfig: ConfirmDialogConfig = {
    title: '',
    message: '',
    confirmButton: { text: '', onClick: () => {} }
  };
  
  // CustomDialogController å®ä¾‹
  private optionPickerDialogController: CustomDialogController | null = null;
  private confirmDialogController: CustomDialogController | null = null;

  /**
   * æ˜¾ç¤ºç¡®è®¤å¼¹çª—
   */
  private showConfirmDialog(config: ConfirmDialogConfig): void {
    this.confirmDialogConfig = config;
    this.confirmDialogController = new CustomDialogController({
      builder: ConfirmDialog({
        config: this.confirmDialogConfig
      }),
      alignment: DialogAlignment.Center,
      customStyle: true,
      backgroundColor: Color.Transparent
    });
    this.confirmDialogController.open();
  }

  aboutToAppear(): void {
    this.updateLayoutConfig();
    
    const params = router.getParams() as AppListPageParams;
    if (params?.computerId) {
      this.computerId = params.computerId;
      this.loadApps();
    } else if (this.isLoading) {
      this.isLoading = false;
    }
  }

  aboutToDisappear(): void {
    this.viewModel.cancelIconLoading();
    // æ¸…ç†å›¾æ ‡è½®è¯¢å®šæ—¶å™¨
    if (this.iconPollIntervalId !== -1) {
      clearInterval(this.iconPollIntervalId);
      this.iconPollIntervalId = -1;
    }
    // æ¸…ç†æœç´¢é˜²æŠ–å®šæ—¶å™¨
    if (this.searchDebounceTimer !== -1) {
      clearTimeout(this.searchDebounceTimer);
      this.searchDebounceTimer = -1;
    }
  }

  onBackPress(): boolean {
    this.viewModel.cancelIconLoading();
    return false;
  }

  /**
   * é¡µé¢é‡æ–°æ˜¾ç¤ºæ—¶åˆ·æ–°åº”ç”¨åˆ—è¡¨çŠ¶æ€
   */
  onPageShow(): void {
    this.updateLayoutConfig();
    
    if (!this.nvHttp && this.computerId) {
      this.loadApps();
      return;
    }
    
    if (this.isLoading && this.nvHttp) {
      this.isLoading = false;
    }
    
    this.refreshApps();
    
    // ä»ä¸²æµè¿”å›æ—¶å»¶è¿Ÿåˆ·æ–°ï¼Œç­‰å¾…æœåŠ¡å™¨çŠ¶æ€æ›´æ–°
    if (this.viewModel.hasRunningApp) {
      setTimeout(() => this.refreshApps(), 1000);
    }
  }

  /**
   * æ›´æ–°å¸ƒå±€é…ç½®ï¼ˆæ ¹æ®å±å¹•æ–¹å‘å’Œappæ•°é‡ï¼‰
   */
  private updateLayoutConfig(): void {
    try {
      const displayInfo = display.getDefaultDisplaySync();
      this.isLandscape = displayInfo.width > displayInfo.height;
      this.calculateOptimalRowCount();
    } catch (err) {
      this.isLandscape = true;
      this.rowCount = DEFAULT_HORIZONTAL_ROW_COUNT;
    }
  }

  /**
   * è®¡ç®—æœ€ä¼˜è¡Œæ•°ï¼ˆå‚è€ƒAndroidé¡¹ç›®çš„é€»è¾‘ï¼‰
   */
  private calculateOptimalRowCount(): void {
    if (this.isLandscape) {
      // æ¨ªå±ï¼šå›ºå®š1è¡Œ
      this.rowCount = DEFAULT_HORIZONTAL_ROW_COUNT;
    } else {
      // ç«–å±ï¼šæ ¹æ®appæ•°é‡åˆ¤æ–­
      const appCount = this.viewModel.filteredApps.length;
      if (appCount === 0) {
        this.rowCount = DEFAULT_VERTICAL_ROW_COUNT;
      } else if (appCount <= VERTICAL_SINGLE_ROW_THRESHOLD) {
        this.rowCount = DEFAULT_HORIZONTAL_ROW_COUNT;
      } else {
        this.rowCount = DEFAULT_VERTICAL_ROW_COUNT;
      }
    }
  }

  private async loadApps(): Promise<void> {
    this.isLoading = true;
    
    try {
      const computer = this.computerManager.getComputer(this.computerId);
      if (!computer) {
        promptAction.showToast({ message: 'æ‰¾ä¸åˆ°ç”µè„‘' });
        router.back();
        return;
      }
      
      if (computer.pairState !== PairState.PAIRED) {
        promptAction.showToast({ message: 'è®¾å¤‡æœªé…å¯¹ï¼Œè¯·é‡æ–°é…å¯¹' });
        router.back();
        return;
      }
      
      this.computerName = computer.name;
      
      const context = getContext(this) as common.UIAbilityContext;
      this.nvHttp = new NvHttp(computer.address, computer.serverCert, context, computer.httpPort);
      
      const apps = await this.nvHttp.getAppList();

      // æ ‡è®°æ­£åœ¨è¿è¡Œçš„åº”ç”¨
      const runningGameId = computer.runningGameId;
      if (runningGameId > 0) {
        for (const app of apps) {
          app.isRunning = (app.id === runningGameId);
        }
      }

      this.viewModel.setApps(apps, this.nvHttp);
      this.calculateOptimalRowCount();
      this.loadDisplays();
      this.waitForFirstAppIcon();
    } catch (err) {
      promptAction.showToast({ message: `åŠ è½½å¤±è´¥: ${(err as Error).message}` });
    } finally {
      this.isLoading = false;
    }
  }
  
  /**
   * ç­‰å¾…ç¬¬ä¸€ä¸ª app å›¾æ ‡åŠ è½½å®Œæˆåè®¾ç½®èƒŒæ™¯
   */
  private waitForFirstAppIcon(): void {
    // å…ˆæ¸…ç†ä¹‹å‰çš„å®šæ—¶å™¨
    if (this.iconPollIntervalId !== -1) {
      clearInterval(this.iconPollIntervalId);
      this.iconPollIntervalId = -1;
    }
    
    if (this.viewModel.filteredApps.length === 0) return;
    
    const firstApp = this.viewModel.filteredApps[0];
    
    const setBackground = () => {
      if (firstApp.iconLoaded && firstApp.localIconPath) {
        this.backgroundImageUrl = `file://${firstApp.localIconPath}`;
        setTimeout(() => {
          animateTo({ duration: 500, curve: Curve.EaseOut }, () => {
            this.backgroundOpacity = 0.7;
          });
        }, 50);
        return true;
      }
      return false;
    };
    
    if (setBackground()) return;
    
    // è½®è¯¢ç­‰å¾…ï¼ˆæœ€å¤š3ç§’ï¼‰
    let attempts = 0;
    this.iconPollIntervalId = setInterval(() => {
      if (setBackground() || ++attempts >= 30) {
        if (this.iconPollIntervalId !== -1) {
          clearInterval(this.iconPollIntervalId);
          this.iconPollIntervalId = -1;
        }
      }
    }, 100);
  }

  /**
   * æ›´æ–°èƒŒæ™¯å›¾
   */
  private updateBackgroundForApp(app: ObservableApp): void {
    if (!app.localIconPath || !app.iconLoaded) return;
    
    const newUrl = `file://${app.localIconPath}`;
    if (this.backgroundImageUrl !== newUrl) {
      animateTo({ duration: 300, curve: Curve.EaseOut }, () => {
        this.backgroundImageUrl = newUrl;
      });
    }
  }

  private async refreshApps(): Promise<void> {
    this.isRefreshing = true;
    
    try {
      const computer = this.computerManager.getComputer(this.computerId);
      if (computer && computer.pairState !== PairState.PAIRED) {
        promptAction.showToast({ message: 'é…å¯¹å·²å¤±æ•ˆï¼Œè¯·é‡æ–°é…å¯¹' });
        router.back();
        return;
      }
      
      if (this.nvHttp) {
        // è·å–æœ€æ–°çš„æœåŠ¡å™¨çŠ¶æ€
        try {
          const serverInfo = await this.nvHttp.getServerInfo();
          if (computer) {
            computer.runningGameId = serverInfo.currentGame;
          }
        } catch {
          // å¿½ç•¥æœåŠ¡å™¨çŠ¶æ€è·å–å¤±è´¥
        }
        
        const apps = await this.nvHttp.getAppList();

        // æ ‡è®°æ­£åœ¨è¿è¡Œçš„åº”ç”¨
        const runningGameId = computer?.runningGameId || 0;
        for (const app of apps) {
          app.isRunning = runningGameId > 0 && app.id === runningGameId;
        }

        this.viewModel.setApps(apps, this.nvHttp);
        this.calculateOptimalRowCount();
      }
    } catch (err) {
      const errMsg = (err as Error).message || '';
      if (errMsg.includes('401') || errMsg.includes('not authorized') || errMsg.includes('Certificate verification')) {
        promptAction.showToast({ message: 'é…å¯¹å·²å¤±æ•ˆï¼Œè¯·é‡æ–°é…å¯¹' });
        router.back();
        return;
      }
      promptAction.showToast({ message: 'åˆ·æ–°å¤±è´¥' });
    } finally {
      this.isRefreshing = false;
    }
  }

  build() {
    Stack() {
      // çº¯è‰²åŸºç¡€èƒŒæ™¯
      Column()
        .width('100%')
        .height('100%')
        .backgroundColor(AppColors.Background)
      
      // èƒŒæ™¯å›¾å±‚ï¼ˆä½¿ç”¨ app å°é¢ï¼Œå¸¦æ·¡å…¥åŠ¨ç”»ï¼‰
      if (this.backgroundImageUrl.length > 0) {
        Image(this.backgroundImageUrl)
          .width('100%')
          .height('100%')
          .objectFit(ImageFit.Cover)
          .opacity(this.backgroundOpacity)
        
        // æ¸å˜å åŠ å±‚
        Column()
          .width('100%')
          .height('100%')
          .linearGradient({
            angle: 180,
            colors: [
              [AppColors.Background, 0.0],
              ['rgba(0,0,0,0)', 0.4],
              [AppColors.Background, 1.0]
            ]
          })
          .opacity(this.backgroundOpacity > 0 ? 1 : 0)
      }
      
      // ä¸»å†…å®¹
      Column() {
        // æ ‡é¢˜æ 
        this.TitleBar()
        
        // å†…å®¹åŒºåŸŸ
        Stack() {
          if (this.isLoading) {
            this.LoadingState()
          } else if (this.viewModel.isEmpty) {
            // å½“åˆ—è¡¨ä¸ºç©ºæ—¶ï¼Œæ˜¾ç¤ºç©ºçŠ¶æ€
            // å³ä½¿åœ¨åˆ·æ–°ä¸­ä¹Ÿæ˜¾ç¤ºï¼Œé¿å…å‡ºç°å®Œå…¨ç©ºç™½çš„é¡µé¢
            this.EmptyState()
          } else {
            Column() {
              // æœç´¢æ  (æ”¾åœ¨å†…å®¹åŒºåŸŸé¡¶éƒ¨ï¼Œç´§è´´ AppGrid)
              if (this.showSearch) {
                this.SearchBar()
              }
              
              this.AppGrid()
            }
            .width('100%')
            .height('100%')
          }
        }
        .layoutWeight(1)
        
        // æ˜¾ç¤ºå™¨é€‰æ‹©æ ï¼ˆåº•éƒ¨ï¼ŒæœåŠ¡å™¨æ”¯æŒ displays API æ—¶æ˜¾ç¤ºï¼‰
        if (this.supportsDisplayApi) {
          this.DisplaySelector()
        }
      }
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor(Color.Transparent)
  }

  @Builder
  TitleBar() {
    Row() {
      // è¿”å›æŒ‰é’® - éœ“è™¹é£æ ¼
      Button({ type: ButtonType.Circle }) {
        Image($r('app.media.ic_back'))
          .width(AppSizes.IconMedium)
          .height(AppSizes.IconMedium)
          .fillColor(AppColors.Primary)
      }
      .width(40)
      .height(40)
      .backgroundColor(AppColors.Surface)
      .borderWidth(1)
      .borderColor(AppColors.CardBorder)
      .onClick(() => router.back())

      // æ ‡é¢˜
      Column() {
        Text(this.computerName || 'åº”ç”¨åˆ—è¡¨')
          .fontSize(AppSizes.FontTitle)
          .fontWeight(FontWeight.Bold)
          .fontColor(AppColors.Primary)

        if (!this.isLoading) {
          Row() {
            Text('ğŸ®')
              .fontSize(12)
              .margin({ right: 4 })
            Text(`${this.viewModel.filteredCount} ä¸ªåº”ç”¨`)
              .fontSize(AppSizes.FontCaption)
              .fontColor(AppColors.TextSecondary)
          }
          .margin({ top: 2 })
        }
      }
      .alignItems(HorizontalAlign.Start)
      .margin({ left: AppSpacing.Medium })

      Blank()

      // æœç´¢æŒ‰é’® - éœ“è™¹é£æ ¼
      Button({ type: ButtonType.Circle }) {
        SymbolGlyph($r('sys.symbol.magnifyingglass'))
          .fontSize(20)
          .fontColor([this.showSearch ? AppColors.TextOnPrimary : AppColors.Accent])
      }
      .width(40)
      .height(40)
      .backgroundColor(this.showSearch ? AppColors.Accent : AppColors.Surface)
      .borderWidth(1)
      .borderColor(this.showSearch ? AppColors.Accent : AppColors.CardBorder)
      .onClick(() => {
        animateTo({ duration: AppAnimation.Normal, curve: AppAnimation.EaseOut }, () => {
          this.showSearch = !this.showSearch;
          if (!this.showSearch) {
            this.searchText = '';
            this.viewModel.setSearchKeyword('');
          }
        });
      })
      
      // åˆ·æ–°æŒ‰é’® - éœ“è™¹é£æ ¼
      Button({ type: ButtonType.Circle }) {
        if (this.isRefreshing) {
          LoadingProgress()
            .width(20)
            .height(20)
            .color(AppColors.Primary)
        } else {
          Image($r('app.media.ic_refresh'))
            .width(AppSizes.IconMedium)
            .height(AppSizes.IconMedium)
            .fillColor(AppColors.Primary)
        }
      }
      .width(40)
      .height(40)
      .backgroundColor(AppColors.Surface)
      .borderWidth(1)
      .borderColor(AppColors.CardBorder)
      .margin({ left: AppSpacing.Small })
      .onClick(() => this.refreshApps())
    }
    .width('100%')
    .padding({
      left: AppSpacing.Large,
      right: AppSpacing.Large,
      top: 56,
      bottom: AppSpacing.Medium
    })
  }

  @Builder
  SearchBar() {
    Row() {
      Row() {
        // æœç´¢å›¾æ ‡
        SymbolGlyph($r('sys.symbol.magnifyingglass'))
          .fontSize(16)
          .fontColor([AppColors.TextTertiary])
          .margin({ right: 8 })

        TextInput({ placeholder: 'æœç´¢æ¸¸æˆ...', text: this.searchText })
          .layoutWeight(1)
          .height(32)
          .fontSize(14)
          .fontColor(AppColors.TextPrimary)
          .placeholderColor(AppColors.TextTertiary)
          .caretColor(AppColors.Primary)
          .backgroundColor(Color.Transparent)
          .onChange((value: string) => {
            this.searchText = value;
            // é˜²æŠ–ï¼š300ms å†…ä¸é‡å¤è§¦å‘æœç´¢
            if (this.searchDebounceTimer !== -1) {
              clearTimeout(this.searchDebounceTimer);
            }
            this.searchDebounceTimer = setTimeout(() => {
              this.viewModel.setSearchKeyword(this.searchText);
              this.searchDebounceTimer = -1;
            }, 300);
          })

        // æ¸…ç©ºæŒ‰é’®
        if (this.searchText.length > 0) {
          Button({ type: ButtonType.Circle }) {
            SymbolGlyph($r('sys.symbol.xmark'))
              .fontSize(10)
              .fontColor([AppColors.TextTertiary])
          }
          .width(24)
          .height(24)
          .backgroundColor(AppColors.Surface)
          .onClick(() => {
            // æ¸…é™¤é˜²æŠ–å®šæ—¶å™¨
            if (this.searchDebounceTimer !== -1) {
              clearTimeout(this.searchDebounceTimer);
              this.searchDebounceTimer = -1;
            }
            this.searchText = '';
            this.viewModel.setSearchKeyword('');
          })
        }
      }
      .height(40)
      .padding({ left: 14, right: 10 })
      .backgroundColor(AppColors.CardBackground)
      .borderRadius(20)
      .borderWidth(1)
      .borderColor(this.searchText.length > 0 ? AppColors.Primary : AppColors.CardBorder)
      .layoutWeight(1)
    }
    .width('100%')
    .padding({ left: 24, right: 24, bottom: 8 })
    .justifyContent(FlexAlign.Center)
    .transition(TransitionEffect.OPACITY.animation({ duration: AppAnimation.Normal }))
  }

  @Builder
  DisplaySelector() {
    Column() {
      // æç¤ºè¯´æ˜
      Text('Foundation Sunshine ä¸“å±åŠŸèƒ½')
        .fontSize(10)
        .fontColor(AppColors.TextTertiary)
        .margin({ bottom: 4 })
      
      Row() {
        // æ˜¾ç¤ºå™¨å›¾æ ‡å’Œæ ‡ç­¾
        Row() {
          SymbolGlyph($r('sys.symbol.display'))
            .fontSize(18)
            .fontColor([AppColors.TextSecondary])
            .margin({ right: 6 })
          Text('ä¸²æµå±å¹•')
            .fontSize(13)
            .fontColor(AppColors.TextSecondary)
        }
        .margin({ right: AppSpacing.Small })

        // æ¨ªå‘æ»šåŠ¨çš„é€‰é¡¹
        Scroll() {
          Row({ space: 8 }) {
            // é»˜è®¤é€‰é¡¹ï¼ˆä¸é€‰æ‹©ä»»ä½•æ˜¾ç¤ºå™¨ï¼‰
            Text('é»˜è®¤')
              .fontSize(12)
              .fontWeight((!this.useVirtualDisplay && this.selectedDisplayIndex === -1) ? FontWeight.Medium : FontWeight.Normal)
              .fontColor((!this.useVirtualDisplay && this.selectedDisplayIndex === -1) ? AppColors.TextOnPrimary : AppColors.TextSecondary)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor((!this.useVirtualDisplay && this.selectedDisplayIndex === -1) ? AppColors.Primary : AppColors.Surface)
              .borderRadius(16)
              .borderWidth(1)
              .borderColor((!this.useVirtualDisplay && this.selectedDisplayIndex === -1) ? AppColors.Primary : AppColors.CardBorder)
              .onClick(() => {
                this.useVirtualDisplay = false;
                this.selectedDisplayIndex = -1;
              })

            // ç‰©ç†æ˜¾ç¤ºå™¨é€‰é¡¹
            ForEach(this.availableDisplays, (disp: DisplayInfo, index: number) => {
              Text(disp.name)
                .fontSize(12)
                .fontWeight((!this.useVirtualDisplay && this.selectedDisplayIndex === index) ? FontWeight.Medium : FontWeight.Normal)
                .fontColor((!this.useVirtualDisplay && this.selectedDisplayIndex === index) ? AppColors.TextOnPrimary : AppColors.TextSecondary)
                .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                .backgroundColor((!this.useVirtualDisplay && this.selectedDisplayIndex === index) ? AppColors.Primary : AppColors.Surface)
                .borderRadius(16)
                .borderWidth(1)
                .borderColor((!this.useVirtualDisplay && this.selectedDisplayIndex === index) ? AppColors.Primary : AppColors.CardBorder)
                .onClick(() => {
                  this.useVirtualDisplay = false;
                  this.selectedDisplayIndex = index;
                })
            }, (disp: DisplayInfo) => `display_${disp.index}`)

            // è™šæ‹Ÿæ˜¾ç¤ºå™¨é€‰é¡¹
            Text('è™šæ‹Ÿæ˜¾ç¤ºå™¨')
              .fontSize(12)
              .fontWeight(this.useVirtualDisplay ? FontWeight.Medium : FontWeight.Normal)
              .fontColor(this.useVirtualDisplay ? AppColors.TextOnPrimary : AppColors.TextSecondary)
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor(this.useVirtualDisplay ? AppColors.Primary : AppColors.Surface)
              .borderRadius(16)
              .borderWidth(1)
              .borderColor(this.useVirtualDisplay ? AppColors.Primary : AppColors.CardBorder)
              .onClick(() => {
                this.useVirtualDisplay = true;
                this.selectedDisplayIndex = -1;
              })
          }
        }
        .scrollable(ScrollDirection.Horizontal)
        .scrollBar(BarState.Off)
        .layoutWeight(1)
      }
      .width('100%')
    }
    .width('100%')
    .alignItems(HorizontalAlign.Start)
    .padding({ left: AppSpacing.Large, right: AppSpacing.Large })
    .margin({ top: AppSpacing.Small, bottom: AppSpacing.Small })
  }

  @Builder
  LoadingState() {
    Column() {
      // åŠ è½½åŠ¨ç”»å®¹å™¨
      Column() {
        LoadingProgress()
          .width(48)
          .height(48)
          .color(AppColors.Primary)
      }
      .width(80)
      .height(80)
      .justifyContent(FlexAlign.Center)
      .borderRadius(40)
      .backgroundColor(AppColors.CardBackground)
      .borderWidth(2)
      .borderColor(AppColors.Primary)
      .shadow({ radius: 20, color: AppColors.GlowGreen, offsetX: 0, offsetY: 0 })

      Text('æ­£åœ¨åŠ è½½åº”ç”¨åˆ—è¡¨...')
        .fontSize(AppSizes.FontBody)
        .fontColor(AppColors.Primary)
        .margin({ top: AppSpacing.Large })

      Text('è¯·ç¨å€™')
        .fontSize(AppSizes.FontCaption)
        .fontColor(AppColors.TextTertiary)
        .margin({ top: AppSpacing.Small })
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  EmptyState() {
    Column() {
      Text(this.viewModel.isSearchEmpty ? 'ğŸ”' : 'ğŸ®')
        .fontSize(40)
        .margin({ bottom: AppSpacing.Medium })

      Text(this.viewModel.isSearchEmpty ? 'æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„åº”ç”¨' : 'æ²¡æœ‰å¯ç”¨çš„åº”ç”¨')
        .fontSize(AppSizes.FontBody)
        .fontColor(AppColors.TextSecondary)

      if (!this.viewModel.isSearchEmpty) {
        Text('åˆ·æ–°')
          .fontSize(AppSizes.FontCaption)
          .fontColor(AppColors.Accent)
          .margin({ top: AppSpacing.Medium })
          .onClick(() => this.refreshApps())
      }
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
  }

  @Builder
  AppGrid() {
    Refresh({ refreshing: $$this.isRefreshing }) {
      // æ¨ªå‘æ»šåŠ¨çš„å¸ƒå±€ï¼ˆå‚è€ƒAndroidé¡¹ç›®çš„å¸ƒå±€æ–¹å¼ï¼‰
      Scroll() {
        // ä½¿ç”¨Columnå¸ƒå±€ï¼Œæ”¯æŒå¤šè¡Œæ¨ªå‘æ’åˆ—
        Column() {
          ForEach(this.generateRows(), (rowApps: ObservableApp[], rowIndex: number) => {
            Row({ space: AppSpacing.Medium }) {
              ForEach(rowApps, (app: ObservableApp) => {
                AppCard({
                  app: app,
                  onTap: () => this.launchApp(app),
                  onLongPress: () => this.openAppMenu(app),
                  onSelect: () => {
                    this.updateBackgroundForApp(app);
                  }
                })
              }, (app: ObservableApp) => `${app.id}_${app.isRunning}_${app.iconLoaded}`)
            }
            .margin({ bottom: rowIndex < this.rowCount - 1 ? AppSpacing.Medium : 0 })
          }, (rowApps: ObservableApp[], rowIndex: number) => {
            // è¡Œçš„ key éœ€è¦åŒ…å«è¯¥è¡Œæ‰€æœ‰åº”ç”¨çš„ ID å’Œè¿è¡ŒçŠ¶æ€
            const appIds = rowApps.map(a => `${a.id}:${a.isRunning ? 1 : 0}`).join(',');
            return `row_${rowIndex}_apps_${appIds}`;
          })
        }
        .padding({
          left: AppSpacing.Large,
          right: AppSpacing.Large,
          top: AppSpacing.Small,
          bottom: AppSpacing.XLarge
        })
        .justifyContent(FlexAlign.Center)
        .alignItems(HorizontalAlign.Start)
      }
      .scrollable(ScrollDirection.Horizontal)
      .scrollBar(BarState.Off)
      .edgeEffect(EdgeEffect.Spring)
      .width('100%')
      .height('100%')
      .align(Alignment.Center)
    }
    .onRefreshing(() => this.refreshApps())
  }

  /**
   * å°†åº”ç”¨åˆ—è¡¨æŒ‰è¡Œåˆ†ç»„
   */
  private generateRows(): ObservableApp[][] {
    const apps = this.viewModel.filteredApps;
    const rows: ObservableApp[][] = [];
    
    if (apps.length === 0 || this.rowCount === 0) {
      return rows;
    }
    
    // è®¡ç®—æ¯è¡Œçš„åº”ç”¨æ•°é‡
    const appsPerRow = Math.ceil(apps.length / this.rowCount);
    
    // æŒ‰è¡Œåˆ†ç»„
    for (let i = 0; i < this.rowCount; i++) {
      const rowApps: ObservableApp[] = [];
      for (let j = 0; j < appsPerRow; j++) {
        const index = j * this.rowCount + i;
        if (index < apps.length) {
          rowApps.push(apps[index]);
        }
      }
      if (rowApps.length > 0) {
        rows.push(rowApps);
      }
    }
    
    return rows;
  }

  /**
   * æ ¹æ®è¡Œæ•°ç”ŸæˆrowsTemplateï¼ˆä¿ç•™ç”¨äºå¯èƒ½çš„åç»­ä½¿ç”¨ï¼‰
   */
  private generateRowsTemplate(): string {
    const templates: string[] = [];
    for (let i = 0; i < this.rowCount; i++) {
      templates.push('1fr');
    }
    return templates.join(' ');
  }

  /**
   * åŠ è½½å¯ç”¨çš„æ˜¾ç¤ºå™¨åˆ—è¡¨ (Sunshine åŠŸèƒ½)
   */
  private async loadDisplays(): Promise<void> {
    if (!this.nvHttp) return;
    
    try {
      this.availableDisplays = await this.nvHttp.getDisplays();
      this.supportsDisplayApi = true;
    } catch {
      this.availableDisplays = [];
      this.supportsDisplayApi = false;
    }
  }

  /**
   * è·å–å½“å‰é€‰æ‹©çš„æ˜¾ç¤ºå™¨ GUID
   */
  private getSelectedDisplayGuid(): string {
    if (this.useVirtualDisplay) {
      return ''; // è™šæ‹Ÿæ˜¾ç¤ºå™¨ä¸éœ€è¦ GUID
    }
    if (this.selectedDisplayIndex >= 0 && this.selectedDisplayIndex < this.availableDisplays.length) {
      const display = this.availableDisplays[this.selectedDisplayIndex];
      return display.guid || display.name;
    }
    return ''; // ä½¿ç”¨é»˜è®¤æ˜¾ç¤ºå™¨
  }

  private async launchApp(app: ObservableApp): Promise<void> {
    // å¦‚æœæœ‰æ­£åœ¨è¿è¡Œçš„åº”ç”¨
    if (this.viewModel.hasRunningApp && this.viewModel.runningApp?.id !== app.id) {
      this.showConfirmDialog({
        title: 'ç¡®è®¤',
        message: `${this.viewModel.runningApp?.name} æ­£åœ¨è¿è¡Œã€‚\nå¯åŠ¨ ${app.name} å°†ä¼šé€€å‡ºå½“å‰åº”ç”¨ã€‚`,
        confirmButton: {
          text: 'ç»§ç»­',
          onClick: () => {
            this.doLaunchApp(app);
          }
        }
      });
    } else {
      this.doLaunchApp(app);
    }
  }

  private doLaunchApp(app: ObservableApp): void {
    const displayGuid = this.getSelectedDisplayGuid();
    router.pushUrl({
      url: 'pages/StreamPage',
      params: {
        computerId: this.computerId,
        appId: app.id,
        appName: app.name,
        cmdList: app.cmdList.length > 0 ? JSON.stringify(app.cmdList) : undefined,
        resume: app.isRunning,
        displayGuid: displayGuid,
        useVdd: this.useVirtualDisplay
      }
    });
  }

  private openAppMenu(app: ObservableApp): void {
    // é•¿æŒ‰æ—¶æ›´æ–°èƒŒæ™¯å›¾
    this.updateBackgroundForApp(app);
    
    const options: OptionItem[] = [];
    const actionMap = new Map<string, () => void>();
    let actionIndex = 0;
    
    const hasOtherRunningApp = this.viewModel.hasRunningApp && this.viewModel.runningApp?.id !== app.id;
    
    if (app.isRunning) {
      // å½“å‰åº”ç”¨æ­£åœ¨è¿è¡Œ
      const resumeKey = `action_${actionIndex++}`;
      actionMap.set(resumeKey, () => this.doLaunchApp(app));
      options.push({
        title: 'æ¢å¤',
        subtitle: 'ç»§ç»­å½“å‰æ¸¸æˆ',
        value: resumeKey
      });
      
      const quitKey = `action_${actionIndex++}`;
      actionMap.set(quitKey, () => this.quitApp());
      options.push({
        title: 'é€€å‡º',
        subtitle: 'å…³é—­å½“å‰è¿è¡Œçš„åº”ç”¨',
        value: quitKey
      });
    } else if (hasOtherRunningApp) {
      // å…¶ä»–åº”ç”¨æ­£åœ¨è¿è¡Œï¼Œæ˜¾ç¤º"é€€å‡ºå¹¶å¯åŠ¨"é€‰é¡¹
      const quitAndStartKey = `action_${actionIndex++}`;
      actionMap.set(quitAndStartKey, () => this.quitAndStartApp(app));
      options.push({
        title: 'é€€å‡ºå¹¶å¯åŠ¨',
        subtitle: `é€€å‡º ${this.viewModel.runningApp?.name} å¹¶å¯åŠ¨æ­¤åº”ç”¨`,
        value: quitAndStartKey
      });
    } else {
      // æ²¡æœ‰åº”ç”¨åœ¨è¿è¡Œ
      const launchKey = `action_${actionIndex++}`;
      actionMap.set(launchKey, () => this.launchApp(app));
      options.push({
        title: 'å¯åŠ¨',
        subtitle: 'å¼€å§‹ä¸²æµ',
        value: launchKey
      });
    }
    
    // HDR é€‰é¡¹ï¼ˆå¦‚æœæ”¯æŒï¼‰
    if (app.isHdrSupported && !app.isRunning) {
      const hdrKey = `action_${actionIndex++}`;
      actionMap.set(hdrKey, () => {
        // TODO: ä»¥ HDR æ¨¡å¼å¯åŠ¨
        this.doLaunchApp(app);
      });
      options.push({
        title: 'å¯åŠ¨ (HDR)',
        subtitle: 'ä»¥ HDR æ¨¡å¼å¯åŠ¨',
        value: hdrKey
      });
    }
    
    // æŸ¥çœ‹è¯¦æƒ…
    const detailsKey = `action_${actionIndex++}`;
    actionMap.set(detailsKey, () => this.showAppDetails(app));
    options.push({
      title: 'æŸ¥çœ‹è¯¦æƒ…',
      subtitle: 'æ˜¾ç¤ºåº”ç”¨ä¿¡æ¯',
      value: detailsKey
    });

    // çŠ¶æ€å‰¯æ ‡é¢˜
    let subtitle = '';
    if (app.isRunning) {
      subtitle = 'æ­£åœ¨è¿è¡Œ';
    } else if (app.isHdrSupported) {
      subtitle = 'æ”¯æŒ HDR';
    }

    this.optionPickerDialogConfig = {
      title: app.name,
      subtitle: subtitle,
      options: options,
      selectedValue: '',
      onSelect: (option: OptionItem) => {
        const action = actionMap.get(option.value as string);
        if (action) {
          action();
        }
      }
    };
    
    // åˆ›å»ºå¹¶æ‰“å¼€å¼¹çª—
    this.optionPickerDialogController = new CustomDialogController({
      builder: OptionPickerDialog({
        config: this.optionPickerDialogConfig
      }),
      alignment: DialogAlignment.Bottom,
      customStyle: true,
      backgroundColor: Color.Transparent
    });
    this.optionPickerDialogController.open();
  }

  /**
   * é€€å‡ºå½“å‰åº”ç”¨å¹¶å¯åŠ¨æ–°åº”ç”¨
   */
  private async quitAndStartApp(app: ObservableApp): Promise<void> {
    if (!this.nvHttp) return;
    
    try {
      if (await this.nvHttp.quitApp()) {
        promptAction.showToast({ message: 'æ­£åœ¨å¯åŠ¨æ–°åº”ç”¨...' });
        setTimeout(() => this.doLaunchApp(app), 500);
      } else {
        promptAction.showToast({ message: 'é€€å‡ºå¤±è´¥' });
      }
    } catch {
      promptAction.showToast({ message: 'é€€å‡ºå¤±è´¥' });
    }
  }

  /**
   * æ˜¾ç¤ºåº”ç”¨è¯¦æƒ…
   */
  private showAppDetails(app: ObservableApp): void {
    const lines: string[] = [
      `åº”ç”¨åç§°: ${app.name}`,
      `åº”ç”¨ ID: ${app.id}`,
      `HDR æ”¯æŒ: ${app.isHdrSupported ? 'æ˜¯' : 'å¦'}`,
      `è¿è¡ŒçŠ¶æ€: ${app.isRunning ? 'è¿è¡Œä¸­' : 'æœªè¿è¡Œ'}`
    ];
    
    // å¦‚æœæœ‰è¶…çº§æŒ‡ä»¤ï¼Œæ˜¾ç¤ºåœ¨è¯¦æƒ…ä¸­
    if (app.cmdList && app.cmdList.length > 0) {
      lines.push('');
      lines.push('æœåŠ¡ç«¯æŒ‡ä»¤:');
      for (const cmd of app.cmdList) {
        lines.push(`  â€¢ ${cmd.name} (${cmd.id})`);
      }
    }
    
    const details = lines.join('\n');
    
    this.confirmDialogConfig = {
      title: 'åº”ç”¨è¯¦æƒ…',
      message: details,
      confirmButton: {
        text: 'ç¡®å®š',
        onClick: () => {}
      }
    };
    
    this.confirmDialogController = new CustomDialogController({
      builder: ConfirmDialog({
        config: this.confirmDialogConfig
      }),
      alignment: DialogAlignment.Center,
      customStyle: true,
      backgroundColor: Color.Transparent
    });
    this.confirmDialogController.open();
  }

  private async quitApp(): Promise<void> {
    if (!this.nvHttp) return;
    
    try {
      if (await this.nvHttp.quitApp()) {
        promptAction.showToast({ message: 'åº”ç”¨å·²é€€å‡º' });
        await this.refreshApps();
      } else {
        promptAction.showToast({ message: 'é€€å‡ºå¤±è´¥' });
      }
    } catch {
      promptAction.showToast({ message: 'é€€å‡ºå¤±è´¥' });
    }
  }
}
